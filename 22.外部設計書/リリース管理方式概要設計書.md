# リリース管理方式概要設計書

## システムアーキテクチャ概要設計書

---

---

## 1. リリース管理設計方針

### 1.1 基本方針

HDBアプリ（Health Data Bank Application）のリリース管理において、以下の基本方針を策定し、安全かつ効率的なリリースプロセスを実現する。

**(1) リリース管理の目的**
- アプリケーションの品質確保とリリースプロセスの標準化
- リリースに伴うリスクの最小化と問題発生時の迅速な対応
- リリース作業の自動化による作業効率の向上とヒューマンエラーの削減

**(2) リリース管理の範囲**
- React Native 0.80.0ベースのモバイルアプリケーション（iOS/Android）
- バックエンドAPI（モックAPI含む）
- 関連する設定ファイル、データベーススキーマ、ドキュメント

**(3) リリース管理の原則**
- すべてのリリースはGitリポジトリで管理され、タグ付けによるバージョン管理を行う
- リリース前には必ず自動テスト（単体テスト、結合テスト）を実施する
- 環境別（開発/検証/本番）のリリースプロセスを定義し、段階的なリリースを行う
- リリース履歴とロールバック手順を明文化し、問題発生時の復旧を迅速化する

### 1.2 対象システム構成

**(1) HDBアプリケーション構成**
- フロントエンド：React Native（TypeScript）
- ナビゲーション：React Navigation（Stack/Drawer）
- 状態管理：React Hooks（useAuth等のカスタムフック）
- データ永続化：SQLite（react-native-sqlite-2）、AsyncStorage
- 認証：モック認証（本番環境では外部認証サービス連携予定）

**(2) プラットフォーム別構成**
- iOS：Xcode、CocoaPods、HealthKit連携（予定）
- Android：Android Studio、Gradle、Google Fit/Health Connect連携（予定）

**(3) 開発環境**
- Node.js 18以上
- React Native CLI
- TypeScript 5.0.4
- Jest（テストフレームワーク）
- ESLint/Prettier（コード品質管理）

---

## 2. リリース管理方式設計

### 2.1 リリース対象成果物

**(1) アプリケーション成果物**

| 成果物種別 | ファイル形式 | 格納場所 | 命名規則 |
|------------|-------------|----------|----------|
| iOSアプリ | .ipa | App Store Connect | HDBApp-ios-v{version}.ipa |
| Androidアプリ | .aab/.apk | Google Play Console | HDBApp-android-v{version}.aab |
| ソースコード | .ts/.tsx/.js | GitHub | feature/機能名、bugfix/不具合名 |
| 設定ファイル | .json/.xml | GitHub | 環境別（dev/stg/prod）に管理 |
| データベーススキーマ | .sql | GitHub | migration_v{version}.sql |

**(2) ドキュメント成果物**

| ドキュメント種別 | 形式 | 管理場所 | 更新タイミング |
|-----------------|------|----------|---------------|
| API仕様書 | Markdown | /doc/仕様書 | API変更時 |
| リリースノート | Markdown | GitHub Releases | リリース時 |
| 操作マニュアル | PDF/Markdown | /doc | 機能追加・変更時 |
| テスト仕様書 | TSV/Markdown | /試験計画 | テスト項目変更時 |

### 2.2 リリースプロセス

**(1) 開発フェーズ（Development）**
- featureブランチでの機能開発
- 単体テスト実施（npm test）
- ESLintによるコード品質チェック（npm run lint）
- プルリクエスト作成とコードレビュー

**(2) ビルドフェーズ（Build）**

**iOS向けビルド**
```bash
cd HDBApp
npm install
cd ios && pod install && cd ..
npx react-native run-ios --configuration Release
# または Xcodeでのアーカイブビルド
```

**Android向けビルド**
```bash
cd HDBApp
npm install
cd android
./gradlew assembleRelease  # APK生成
./gradlew bundleRelease    # AAB生成
```

**(3) テストフェーズ（Test）**
- 自動テスト実行（Jest）
- 結合テスト実施
- 受入テスト実施
- セキュリティスキャン

**(4) リリースフェーズ（Release）**
- リリースタグ作成（git tag v1.0.0）
- TestFlight/Internal Testing配信
- 段階的リリース（10% → 50% → 100%）
- 本番環境デプロイ

### 2.3 環境別リリース方式

| 環境 | 用途 | ビルド設定 | 配信方法 | 更新頻度 |
|------|------|------------|----------|----------|
| 開発環境 | 開発・デバッグ | Debug | Metro Bundler | 随時 |
| 検証環境 | テスト・検証 | Release | TestFlight/内部テスト | 週次 |
| 本番環境 | 本番サービス | Release | App Store/Google Play | 月次 |

---

## 3. システム構成変更方式

### 3.1 構成変更対象

**(1) アプリケーション構成変更**

| 変更対象 | 変更内容 | 影響範囲 | 変更手順 |
|----------|----------|----------|----------|
| React Nativeバージョン | 0.80.0からのアップグレード | 全体 | package.json更新、依存関係解決 |
| ナビゲーション構造 | 画面遷移の追加・変更 | AppNavigator.tsx | StackNavigator/DrawerNavigator修正 |
| データベーススキーマ | テーブル追加・変更 | SQLite | マイグレーションスクリプト実行 |
| 認証方式 | モック認証から本番認証へ | useAuth hook | 認証サービス統合 |
| 外部サービス連携 | HealthKit/Google Fit | ネイティブモジュール | プラットフォーム別実装 |

**(2) 依存ライブラリ変更**

現在のHDBアプリの主要依存関係：
- @react-navigation/native: ^7.1.14
- @react-navigation/stack: ^7.4.1
- @react-navigation/drawer: ^7.5.1
- react-native-sqlite-2: ^3.6.2
- @react-native-async-storage/async-storage: ^2.2.0
- react-native-webview: ^13.15.0

### 3.2 構成変更プロセス

**(1) 変更計画フェーズ**
- 変更要求の受付と影響分析
- package.json、Podfile、build.gradleの変更計画
- テスト計画の策定

**(2) 変更実施フェーズ**

**依存関係更新手順**
```bash
# パッケージ更新
cd HDBApp
npm update [package-name]

# iOS依存関係更新
cd ios
pod update

# Android依存関係更新
cd ../android
./gradlew clean
./gradlew build
```

**データベーススキーマ変更**
```typescript
// src/services/DatabaseService.ts のマイグレーション
const migrations = [
  { version: 1, sql: 'CREATE TABLE users ...' },
  { version: 2, sql: 'ALTER TABLE vital_data ADD COLUMN ...' },
  // 新規マイグレーション追加
];
```

**(3) 変更検証フェーズ**
- 単体テスト実行（npm test）
- 結合テスト実行
- iOS/Android実機テスト
- パフォーマンステスト

### 3.3 ロールバック方式

| 対象 | ロールバック方法 | 所要時間 | 備考 |
|------|-----------------|----------|------|
| アプリバージョン | 前バージョンの再配信 | 1-2時間 | ストア審査不要 |
| データベース | バックアップからの復元 | 30分 | 定期バックアップ必須 |
| 設定ファイル | Git revert | 10分 | 即座に反映可能 |
| 依存ライブラリ | package-lock.json復元 | 20分 | node_modules再構築 |

---

## 4. リリース管理通信方式

### 4.1 ビルド・デプロイ自動化

**(1) GitHub Actionsによる自動化設定（予定）**

```yaml
# .github/workflows/release.yml
name: HDB App Release
on:
  push:
    branches: [main]
    tags: ['v*']

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      - run: |
          cd HDBApp
          npm ci
          npm test
          npm run lint

  build-android:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Build Android
        run: |
          cd HDBApp/android
          ./gradlew bundleRelease

  build-ios:
    needs: test
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v3
      - name: Build iOS
        run: |
          cd HDBApp/ios
          pod install
          xcodebuild -workspace HDBApp.xcworkspace -scheme HDBApp archive
```

**(2) 手動ビルド・デプロイ手順（現行）**

| プラットフォーム | ビルドコマンド | 成果物 | 配信方法 |
|-----------------|---------------|--------|----------|
| iOS | Xcode Archive | .ipa | TestFlight/App Store Connect |
| Android | ./gradlew bundleRelease | .aab | Google Play Console |

### 4.2 環境間通信設定

**(1) API通信設定**

```typescript
// src/services/api/apiClient.ts の環境別設定
const API_CONFIG = {
  development: {
    baseURL: 'http://localhost:3000',
    timeout: 30000,
  },
  staging: {
    baseURL: 'https://stg-api.hdb-app.com',
    timeout: 30000,
  },
  production: {
    baseURL: 'https://api.hdb-app.com',
    timeout: 30000,
  },
};
```

**(2) セキュリティ設定**

| セキュリティ項目 | 実装方法 | 管理場所 |
|-----------------|----------|----------|
| APIキー | 環境変数 | .env.local（gitignore） |
| 認証トークン | AsyncStorage/Keychain | デバイスローカル |
| 通信暗号化 | HTTPS/TLS 1.3 | ネットワーク層 |
| 証明書ピニング | react-native-ssl-pinning | アプリ内蔵 |

### 4.3 リリース通知・監視

**(1) 通知設定**

| イベント | 通知先 | 通知方法 | タイミング |
|----------|--------|----------|------------|
| ビルド開始 | 開発チーム | Slack/Email | 即時 |
| テスト失敗 | 担当開発者 | Slack/Email | 即時 |
| リリース完了 | 全体チーム | Slack/Email | 完了時 |
| エラー検知 | 運用チーム | PagerDuty | リアルタイム |

**(2) 監視項目**

| 監視対象 | メトリクス | 閾値 | アラート条件 |
|----------|------------|------|-------------|
| アプリクラッシュ率 | クラッシュ数/セッション数 | > 1% | 即時通知 |
| API応答時間 | 平均レスポンスタイム | > 3秒 | 警告通知 |
| メモリ使用量 | アプリメモリ使用量 | > 200MB | 警告通知 |
| バッテリー消費 | 時間あたり消費率 | > 5%/h | 調査対象 |

---

## 5. デグレーション対策

### 5.1 品質保証プロセス

**(1) テスト戦略**

| テスト種別 | 対象 | 実施タイミング | カバレッジ目標 | ツール |
|------------|------|---------------|---------------|--------|
| 単体テスト | コンポーネント/関数 | コミット時 | 80%以上 | Jest |
| 結合テスト | 画面遷移/API連携 | PR作成時 | 主要機能100% | Jest + Testing Library |
| スナップショットテスト | UIコンポーネント | PR作成時 | 全画面 | Jest |
| 手動テスト | 実機動作確認 | リリース前 | 全機能 | TestFlight/内部テスト |

**(2) 現在のテスト実装状況**

HDBアプリの既存テスト：
- コンポーネントテスト：__tests__/components/
- 画面テスト：__tests__/screens/
- サービステスト：__tests__/services/
- フックテスト：__tests__/hooks/

テスト実行コマンド：
```bash
cd HDBApp
npm test              # 全テスト実行
npm run test:watch    # ウォッチモード
npm run test:coverage # カバレッジレポート生成
```

### 5.2 デグレーション検出

**(1) 自動検出項目**

| 検出項目 | 検出方法 | 基準値 | 対応 |
|----------|----------|--------|------|
| ビルドエラー | CI/CD | ビルド失敗 | リリース中止 |
| テスト失敗 | Jest | テスト失敗 | リリース中止 |
| Lintエラー | ESLint | エラー検出 | 修正必須 |
| 型エラー | TypeScript | 型チェック失敗 | 修正必須 |
| 依存関係の脆弱性 | npm audit | High以上 | 更新検討 |

**(2) 実行時エラー監視**

```typescript
// src/utils/ErrorHandler.tsx のエラー監視
class ErrorBoundary extends React.Component {
  componentDidCatch(error: Error, errorInfo: ErrorInfo) {
    // エラーログ送信
    console.error('Error caught:', error, errorInfo);
    // クラッシュレポート送信（本番環境）
    // crashlytics.recordError(error);
  }
}
```

### 5.3 リカバリー手順

**(1) アプリケーションロールバック**

| 状況 | 対応手順 | 所要時間 | 影響範囲 |
|------|----------|----------|----------|
| ストア公開前 | TestFlight/内部テスト版を削除 | 即時 | テストユーザーのみ |
| ストア公開後（iOS） | 前バージョンを緊急リリース | 1-2日（審査） | 全ユーザー |
| ストア公開後（Android） | 段階的ロールアウト停止 | 即時 | 新規ユーザーのみ |
| 緊急修正必要 | Hotfixブランチで修正 | 1-3日 | 全ユーザー |

**(2) データベースリカバリー**

```typescript
// SQLiteデータベースのバックアップとリストア
// src/services/DatabaseService.ts

export const backupDatabase = async () => {
  // データベースファイルのコピー作成
  const dbPath = await getDbPath();
  const backupPath = `${dbPath}.backup_${Date.now()}`;
  await copyFile(dbPath, backupPath);
  return backupPath;
};

export const restoreDatabase = async (backupPath: string) => {
  // バックアップからの復元
  const dbPath = await getDbPath();
  await copyFile(backupPath, dbPath);
  // アプリ再起動推奨
};
```

**(3) 設定ロールバック**

```bash
# Git履歴からの設定復元
git checkout <previous-commit> -- HDBApp/app.json
git checkout <previous-commit> -- HDBApp/package.json
cd HDBApp && npm install
```

---

## 6. 構成管理方式

### 6.1 ソースコード構成管理

**(1) GitHubリポジトリ構成**

```
hdb/
├── HDBApp/              # React Nativeアプリケーション
│   ├── src/            # ソースコード
│   │   ├── components/ # UIコンポーネント
│   │   ├── screens/    # 画面コンポーネント
│   │   ├── services/   # ビジネスロジック
│   │   ├── hooks/      # カスタムフック
│   │   ├── navigation/ # ナビゲーション
│   │   └── types/      # 型定義
│   ├── __tests__/      # テストコード
│   ├── ios/            # iOSネイティブコード
│   ├── android/        # Androidネイティブコード
│   └── package.json    # 依存関係定義
├── doc/                 # ドキュメント
│   ├── 仕様書/
│   ├── 設計資料/
│   └── 環境構築/
└── 試験計画/           # テスト仕様書
```

**(2) ブランチ戦略**

| ブランチ | 用途 | マージ先 | 保護設定 |
|----------|------|----------|----------|
| main | 本番リリース版 | - | 直接プッシュ禁止 |
| develop | 開発統合 | main | PRレビュー必須 |
| feature/* | 機能開発 | develop | - |
| bugfix/* | バグ修正 | develop | - |
| hotfix/* | 緊急修正 | main | PRレビュー必須 |
| release/* | リリース準備 | main | PRレビュー必須 |

### 6.2 バージョン管理

**(1) アプリケーションバージョン**

```json
// HDBApp/package.json
{
  "name": "HDBApp",
  "version": "0.0.1",  // セマンティックバージョニング
  // MAJOR.MINOR.PATCH
  // MAJOR: 後方互換性のない変更
  // MINOR: 後方互換性のある機能追加
  // PATCH: バグ修正
}
```

**(2) プラットフォーム別バージョン管理**

| プラットフォーム | バージョンファイル | ビルド番号 |
|-----------------|-------------------|------------|
| iOS | Info.plist | CFBundleVersion |
| Android | build.gradle | versionCode/versionName |

### 6.3 依存関係管理

**(1) 現在の主要依存関係（HDBApp/package.json）**

| パッケージ | バージョン | 用途 |
|-----------|------------|------|
| react-native | 0.80.0 | フレームワーク |
| @react-navigation/* | ^7.x | 画面遷移 |
| react-native-sqlite-2 | ^3.6.2 | ローカルDB |
| @react-native-async-storage | ^2.2.0 | データ永続化 |
| react-native-webview | ^13.15.0 | WebView表示 |
| typescript | 5.0.4 | 型定義 |
| jest | ^29.6.3 | テスト |

**(2) 依存関係更新ポリシー**

| 更新種別 | 頻度 | 条件 |
|----------|------|------|
| セキュリティパッチ | 即時 | Critical/High脆弱性 |
| バグ修正 | 週次 | 影響評価後 |
| マイナーアップデート | 月次 | テスト検証後 |
| メジャーアップデート | 四半期 | 十分な検証期間確保 |

### 6.4 成果物管理

**(1) ビルド成果物**

| 成果物 | 形式 | 保管場所 | 保持期間 | 命名規則 |
|--------|------|----------|----------|----------|
| iOSアプリ | .ipa | TestFlight | 90日 | HDBApp-v{version}-{build}.ipa |
| Androidアプリ | .aab | Play Console | 無期限 | HDBApp-v{version}-{build}.aab |
| テストAPK | .apk | 共有ドライブ | 30日 | HDBApp-debug-{date}.apk |
| ソースコード | .zip | GitHub Release | 無期限 | HDBApp-src-v{version}.zip |

**(2) ドキュメント管理**

現在のドキュメント構成：
- /doc/仕様書/ - 機能仕様、IF仕様
- /doc/設計資料/ - アーキテクチャ、DB設計
- /doc/環境構築/ - セットアップ手順
- /試験計画/ - テスト仕様書
- /README.md - プロジェクト概要
- /CLAUDE.md - AI開発ガイド

### 6.5 リリースチェックリスト

**コード変更完了**
- [ ] 機能実装完了
- [ ] バグ修正完了
- [ ] コードレビュー承認

**テスト完了**
- [ ] 単体テスト（npm test）PASS
- [ ] Lintチェック（npm run lint）PASS
- [ ] iOS実機テスト完了
- [ ] Android実機テスト完了

**バージョン更新**
- [ ] package.json バージョン更新
- [ ] iOS Info.plist更新
- [ ] Android build.gradle更新

**ビルド成果物作成**
- [ ] iOS リリースビルド作成
- [ ] Android リリースビルド作成
- [ ] リリースノート作成

**配信準備**
- [ ] TestFlight/内部テスト配信
- [ ] ステークホルダー承認
- [ ] 本番配信スケジュール確定

**事後作業**
- [ ] リリースタグ作成
- [ ] ドキュメント更新
- [ ] 次バージョン計画策定

---

## 付録A. トラブルシューティング

| 問題事象 | 原因 | 対処方法 |
|----------|------|----------|
| npm install失敗 | node_modules不整合 | rm -rf node_modules && npm install |
| iOS ビルド失敗 | Pod不整合 | cd ios && pod deintegrate && pod install |
| Android ビルド失敗 | Gradle キャッシュ | cd android && ./gradlew clean |
| Metro bundler エラー | キャッシュ不整合 | npx react-native start --reset-cache |
| TypeScriptエラー | 型定義不整合 | npm run tsc --noEmit |

## 付録B. コマンドリファレンス

```bash
# 開発環境セットアップ
cd HDBApp
npm install
cd ios && pod install && cd ..

# 開発サーバー起動
npm start

# アプリ起動
npm run ios      # iOS
npm run android  # Android

# テスト実行
npm test
npm run test:coverage

# コード品質チェック
npm run lint

# リリースビルド
cd ios && xcodebuild -workspace HDBApp.xcworkspace -scheme HDBApp -configuration Release
cd android && ./gradlew bundleRelease
```

---

## 文書情報

- **文書名**: リリース管理方式概要設計書
- **目的**: プログラム、スクリプト、設定ファイルを各種環境にリリースする仕組みを網羅的に整理し、検証可能にする
- **作成日**: 2025/08/22
- **バージョン**: 1.0

---

## 改訂履歴

| 版数 | 版改訂日 | 変更箇所 | 変更理由 | 変更内容 | 変更者 | 承認者 |
|------|----------|----------|----------|----------|--------|--------|
| 1.0 | 2025/08/22 | 初版発行 | 新規作成 | HDBアプリリリース管理方式の初版作成 | - | - |