# ログ管理方式概要設計書

Health Data Bank (HDB) モバイルアプリケーション

| 版数 | 版改訂日 | 変更箇所 | 変更理由 | 変更内容 | 変更者 | 承認者 |
|------|----------|----------|----------|----------|--------|--------|
| 1.0 | 2025/08/08 | 初版発行 | HDBアプリログ管理方式策定 | ログ管理方式概要設計書作成 | システム設計チーム | プロジェクトマネージャー |

---

目次

1. [目的](#1-目的)
2. [ログ管理要求](#2-ログ管理要求)
3. [ログ管理方針](#3-ログ管理方針)
4. [管理対象ログ一覧](#4-管理対象ログ一覧)
5. [管理対象ログ容量](#5-管理対象ログ容量)
6. [ログローテーション方式](#6-ログローテーション方式)
7. [ログバックアップ方式](#7-ログバックアップ方式)
8. [セキュリティ](#8-セキュリティ)
9. [システム基盤制御機能](#9-システム基盤制御機能)
10. [運用作業支援ツール](#10-運用作業支援ツール)
11. [ログ管理標準](#11-ログ管理標準)
12. [製品検討](#12-製品検討)

---


1. 目的

本書は、ヘルスデータバンク（HDB）モバイルアプリケーションにおけるログ管理の仕組みについて定義し、管理要求、管理方針、管理対象ログ、ログローテーション方式、ログバックアップ方式、セキュリティ、システム基盤制御機能、運用作業支援ツール、ログ管理標準について包括的に整理することを目的とする。

2. ログ管理要求

2.1 機能要求

ログ記録要求
- アプリケーションエラー及び予期しない動作の記録
- API通信の成功・失敗ログの記録
- ユーザー認証・認可に関するセキュリティログの記録
- パフォーマンス監視のためのログ記録
- データ同期・バックアップ操作のログ記録

ログ検索・参照要求
- エラー発生時の迅速な原因特定
- セキュリティインシデント発生時の監査証跡確保
- パフォーマンス分析のためのデータ提供
- 運用状況監視のためのログ参照

2.2 非機能要求

性能要求（非機能要求項目5対応）
- ログ出力処理がアプリケーション性能に与える影響を最小化
- CPU使用率50%以下、メモリ使用量200MB以下を維持
- ログファイルサイズがデバイスストレージ容量を圧迫しないよう制御
- ログ検索・参照処理の応答時間を1秒以内に確保

可用性要求（非機能要求項目10,11対応）
- アプリケーション障害時もログ記録機能を維持
- 予期せぬエラー時もクラッシュ防止、ユーザー向けエラーメッセージ表示
- ネットワーク断絶時もローカルログ記録を継続
- ログファイル破損時の復旧機能を提供

セキュリティ要求（非機能要求項目15,16対応）
- 個人情報及び機密情報のログ記録禁止
- 保存データのAES256暗号化
- ログファイルへの不正アクセス防止
- ログ転送時のTLS1.3暗号化

3. ログ管理方針

3.1 基本方針

最小限収集の原則
- モバイル端末リソース制約を考慮し、必要最小限のログのみ収集
- 現在はconsole出力とAsyncStorage保存による基本的なログ管理
- デバイス内ログ総容量：最大100MB

効率的管理
- ErrorBoundaryによるアプリクラッシュ捕捉とAsyncStorage保存（実装済み）
- エラーログ50件の上限設定（実装済み）
- 通知履歴50件の上限設定（実装済み）

開発・デバッグ効率化
- console出力による開発時の問題特定支援
- __DEV__フラグによる開発環境でのエラー詳細表示

将来拡張への対応
- ログ取得・削除機能の基盤実装
- API通信エラーハンドリングの枠組み整備

3.2 技術方針

モバイルアプリケーション（React Native）
- ErrorBoundaryによるアプリクラッシュ捕捉（実装済み）
- AsyncStorageによるエラーログ永続化（実装済み）
- console出力による開発時デバッグ情報提供
- 通知履歴のメモリ内管理（実装済み）

サーバーサイド
- 基本的なAPI設計（インターフェース定義済み）
- モックAPIによる開発・テスト環境

3.3 環境別方針

ログレベル管理
- ERROR: アプリケーション障害・重要なエラー情報
- WARN: 警告情報・性能劣化要因
- INFO: 一般的な動作情報・業務処理実行状況
- DEBUG: 開発・テスト時のデバッグ情報（本番環境では無効）

環境別設定
- 本番環境: ERRORレベルのみ記録、個人情報記録禁止
- テスト環境: WARN以上を記録、テスト用データのみ
- 開発環境: 全レベルを記録、詳細なデバッグ情報を含む

プライバシー保護方針
- 個人識別可能情報（PII）のログ記録を原則禁止
- 必要に応じてハッシュ化・匿名化処理を実施
- 医療情報・バイタルデータの生値記録禁止

4. 管理対象ログ一覧

管理対象のログ一覧を洗い出し、以下の観点で一覧を作成する。

1) ログローテーション: ログごとにローテーションの方式を記載する。
2) ログ削除: ログごとに削除する方式やディスク上での保存期間を記載する。  
3) バックアップ: バックアップ対象となるログと、バックアップ媒体上での保存期間を記載する。
4) 容量: ディスク容量や、バックアップ媒体の容量を見積もるための基礎数値となる各ログの容量を明確化する。

4.1 HDBモバイルアプリログ対象（実装状況）

| カテゴリ | ログ種別 | 実装状況 | 保存場所 | ローテーション | 削除方式・保存期間 | バックアップ | 1日容量 | 重要度 |
|----------|----------|----------|----------|-------------|----------------|-----------|---------|--------|
| エラー | アプリクラッシュ | ✅ 実装済み | AsyncStorage | 件数ベース | 最新50件のみ保持 | なし | 10MB | 高 |
| | API通信エラー | 🔄 部分実装 | console | なし | 開発時のみ | なし | 50MB | 中 |
| 操作 | 画面遷移 | ⭕ console出力 | - | なし | 開発時のみ | なし | 20MB | 低 |
| | エラーメッセージ表示 | ✅ 実装済み | ErrorHandler | 件数ベース | 最新50件のみ保持 | なし | 5MB | 中 |
| 通知 | 通知履歴 | ✅ 実装済み | メモリ内 | 件数ベース | 最新50件のみ保持 | なし | 2MB | 中 |
| | 通知表示ログ | ⭕ console出力 | console | なし | 開発時のみ | なし | 5MB | 低 |
| システム | 開発時エラー詳細 | ✅ 実装済み | __DEV__表示 | なし | 開発時のみ | なし | 10MB | 高 |

4.2 外部システムログ対象（予定）

| システム | ログ種別 | 実装状況 | 管理場所 | ローテーション | 削除方式・保存期間 | バックアップ |
|----------|----------|----------|----------|-------------|----------------|-----------|
| バイタルAWS | API通信ログ | 📋 未実装 | サーバー | サーバー管理 | サーバー管理 | サーバー管理 |
| HDBシステム | WebView表示ログ | 📋 未実装 | アプリ内 | 件数ベース | 最新100件予定 | なし |
| Firebase | Push通知ログ | 📋 未実装 | Firebase Console | Firebase管理 | Firebase管理 | Firebase管理 |

管理対象ログ一覧については、別紙「ログ管理方式概要設計書_別紙_ログ管理対象一覧」参照。


5. 管理対象ログ容量

5.1 容量見積もり

環境別容量見積もり
| 環境分類 | 1日あたり容量 | 月間容量 | 年間容量 | 備考 |
|---------|--------------|----------|----------|------|
| 本番環境（1ユーザー） | 20MB | 600MB | 7GB | エラー・認証ログのみ |
| 開発環境 | 1.1GB | 33GB | 400GB | 全レベルログ含む |
| CI/CDサーバー | 510MB | 15GB | 180GB | ビルド・テストログ |

現在の実装状況による容量内訳
- エラーログ: 最大50件 × 約5KB = 250KB（実装済み）
- 通知履歴: メモリ内50件（永続化なし、実装済み）
- console出力: 開発時のみ、容量制限なし
- 合計ストレージ: 約250KB/端末（本番環境）

5.2 容量監視・制御

監視閾値（計画）
- 警告閾値：総容量80MB（80%使用）
- 危険閾値：総容量90MB（90%使用）  
- 緊急削除閾値：総容量95MB（95%使用）

現在の制御方式（実装済み）
- エラーログ: 50件上限で古いエントリ自動削除
- 通知履歴: 50件上限で古いエントリ自動削除
- リアルタイム容量監視機能: 未実装

6. ログローテーション方式

6.1 ローテーション方針

モバイル環境特有の考慮事項
- 従来のサーバーアプリケーションと異なり、ファイルベースのローテーションではなくデータベース（AsyncStorage）ベースの管理
- 件数ベース・時間ベースの複合管理方式を採用

ローテーション種別
- 件数ベースローテーション: 最大保持件数を超過時に古いエントリから削除（実装済み）
- 時間ベースローテーション: 一定期間経過したエントリを自動削除（未実装）
- 容量ベースローテーション: ストレージ容量制限に基づく削除（未実装）

6.2 実装済みローテーション

エラーログローテーション（実装済み）
```typescript
// ErrorHandler.tsx実装済み
if (logs.length > 50) {
  logs.splice(0, logs.length - 50);
}
```

通知履歴ローテーション（実装済み）
```typescript
// NotificationService.ts実装済み
if (this.notifications.length > 50) {
  this.notifications = this.notifications.slice(-50);
}
```

6.3 ログ種別ローテーション設定

| ログ種別 | ローテーション方式 | 保持件数/期間 | 削除タイミング | 実装状況 |
|---------|------------------|-------------|--------------|---------|
| エラーログ | 件数ベース | 最新50件 | 新規追加時 | ✅ 実装済み |
| 通知履歴 | 件数ベース | 最新50件 | 新規追加時 | ✅ 実装済み |
| API通信ログ | なし | 開発時のみ | - | 📋 未実装 |
| パフォーマンスログ | 時間ベース | 24時間 | 日次バッチ | 📋 未実装 |
| デバッグログ | 時間ベース | 1時間 | アプリ終了時 | 📋 未実装 |

6.4 実装方式

AsyncStorage管理（実装済み）
```javascript
// ログエントリ追加時の自動ローテーション
async function addLogEntry(logType, logEntry) {
  const logs = await getStoredLogs(logType);
  logs.push(logEntry);
  
  // 件数制限チェック
  const maxCount = getMaxLogCount(logType);
  if (logs.length > maxCount) {
    logs.splice(0, logs.length - maxCount);
  }
  
  await AsyncStorage.setItem(logType, JSON.stringify(logs));
}
```

7. ログバックアップ方式

7.1 バックアップ方針

基本方針
- モバイル環境では自動バックアップ機能は制限的
- 重要ログのみクラウド同期対象とする
- ユーザープライバシー保護を最優先

バックアップ対象
- 対象: エラーログ、クラッシュログ（個人情報除去後）
- 非対象: デバッグログ、パフォーマンスログ、個人情報を含むログ

7.2 現在のバックアップ状況

実装済み
- AsyncStorage: OS標準バックアップ対象（iOS iCloud、Android Google Drive）
- 通知履歴: メモリ内のみ（永続化・バックアップなし）

未実装
- エラーログエクスポート機能
- クラウドバックアップ
- ファイル出力機能
- 手動バックアップ機能

7.3 将来実装予定のバックアップ方式

ローカルバックアップ
- デバイス内SQLiteデータベースへの二重化
- iCloudバックアップ・Google Driveバックアップとの連携
- アプリデータ全体のバックアップに含める

クラウドバックアップ
- 匿名化処理後のエラーログをクラウドに送信
- 開発者向けクラッシュレポートサービス（Firebase Crashlytics等）の活用
- API経由での自動アップロード（ユーザー同意前提）

7.4 復旧方式

ローカル復旧
- アプリ再インストール時の自動復旧
- デバイス間データ移行時のログ復旧
- 手動復旧機能（設定画面から実行）

クラウド復旧
- 開発者向けのログ収集・分析システム
- ユーザーサポート時のログ参照機能
- 障害調査時のログダウンロード機能


8. セキュリティ

8.1 セキュリティ要件（非機能要求項目15,16,18対応）

データ保護
- ログファイルの暗号化（AES-256）
- アクセス権限の厳格な管理
- 個人情報・機密情報の記録禁止
- iOS Keychain・Android Keystoreの活用

伝送時セキュリティ
- TLS 1.3による通信暗号化
- 証明書ピンニング実装
- 中間者攻撃対策

保存時セキュリティ
- デバイスロック機能との連携
- アプリ固有領域での保存
- 暗号化されたAsyncStorageの利用

8.2 アクセス制御

アクセス権限管理
- 開発者のみログファイルアクセス可能
- 運用担当者は匿名化ログのみ参照可能
- ユーザーは自身のログ削除権限保有

監査ログ
- ログファイルアクセス履歴の記録
- 異常なアクセスパターンの検出
- セキュリティインシデント発生時の追跡機能

8.3 プライバシー保護（非機能要求項目18対応）

個人情報保護
- 個人識別情報（PII）のマスキング処理
- IPアドレス・デバイスIDの匿名化
- 位置情報の記録禁止

法的要件遵守
- GDPR・個人情報保護法準拠
- データ処理の透明性確保
- ユーザー同意に基づくログ収集

9. システム基盤制御機能

9.1 ログ管理基盤

ログ出力制御機能
- 環境別ログレベル制御
- 動的ログレベル変更機能（計画）
- パフォーマンス影響最小化

ストレージ管理機能
- 自動容量監視・制御（実装済み：件数ベース）
- 緊急時ログ削除機能（計画）
- ストレージ使用量最適化

障害時制御機能
- ログ出力失敗時の代替処理（実装済み：ErrorBoundary）
- 無限ループ防止機能
- メモリリーク防止機能

9.2 パフォーマンス制御

非同期処理
- ログ出力の非同期化
- バックグラウンド処理による影響軽減
- UIスレッドブロック防止

リソース管理（非機能要求項目5対応）
- メモリ使用量監視・制御
- CPU使用率制限機能
- バッテリー消費最適化

10. 運用作業支援ツール

10.1 ログ監視ツール

現在利用可能な監視機能
- console出力による開発時監視
- ErrorBoundaryによるクラッシュ監視
- AsyncStorageのログ蓄積状況確認

将来実装予定の監視機能
- エラー発生率監視ダッシュボード
- パフォーマンス指標可視化
- アラート通知機能

10.2 運用効率化ツール

実装済み機能
- 手動ログ取得機能（getErrorLogs()）
- 手動ログクリア機能（clearErrorLogs()）
- テスト実行時のログ確認機能

計画中の自動化機能
- 定期レポート自動生成
- 異常検知時の自動通知
- ログローテーション自動実行

10.3 ユーザーサポート機能

ユーザー向け機能（計画）
- ログ削除機能（設定画面）
- ストレージ使用量表示
- プライバシー設定管理

サポート担当者向け機能（計画）
- 匿名化ログ参照機能
- 問い合わせ時のログ確認
- 障害解析支援機能

11. ログ管理標準

11.1 ログフォーマット標準

共通フォーマット
```json
{
  "timestamp": "2025-01-01T00:00:00.000Z",
  "level": "ERROR|WARN|INFO|DEBUG",
  "category": "APP|API|AUTH|SYNC|SECURITY",
  "message": "ログメッセージ",
  "userId": "ハッシュ化されたユーザーID（任意）",
  "sessionId": "セッションID",
  "deviceInfo": {
    "platform": "iOS|Android",
    "version": "アプリバージョン",
    "osVersion": "OSバージョン"
  },
  "additional": {}
}
```

実装済みエラーログフォーマット
```json
{
  "timestamp": "2025-01-01T00:00:00.000Z",
  "error": {
    "name": "エラー名",
    "message": "エラーメッセージ",
    "stack": "スタックトレース（開発環境のみ）"
  },
  "errorInfo": "エラー詳細情報",
  "userAgent": "React Native App"
}
```

11.2 ログ出力標準

出力規則
- 必要最小限の情報のみ記録
- 個人情報・機密情報の記録禁止
- 構造化されたJSONフォーマット使用（一部実装済み）
- タイムスタンプはUTC形式で統一（実装済み）

性能考慮事項
- ログ出力がメインスレッドをブロックしない
- 大量ログ出力時の制御機能（件数制限実装済み）
- メモリリーク防止対策

11.3 開発・運用標準

開発時標準
- ESLint・TypeScriptルールに準拠
- テストコードでのログ出力検証
- コードレビュー時のログ出力チェック

運用時標準
- 定期的なログ容量監視
- エラーログの傾向分析
- セキュリティインシデント発生時の対応手順

12. 製品検討

12.1 ログ管理製品比較

モバイルアプリ向けログ管理サービス

| 製品名 | 特徴 | コスト | HDB適用可否 | 検証項目 |
|--------|------|--------|-----------|----------|
| Firebase Crashlytics | クラッシュレポート特化、Google製品 | 無料 | ○ | クラッシュログ収集精度 |
| Sentry | エラートラッキング、多言語対応 | 有料 | ○ | React Nativeサポート |
| Bugsnag | エラー監視、詳細な分析機能 | 有料 | ○ | プライバシー保護機能 |
| LogRocket | セッション記録、ユーザー行動分析 | 有料 | △ | プライバシー懸念 |
| Rollbar | リアルタイムエラー監視 | 有料 | ○ | 日本語サポート |

自社開発 vs サードパーティ比較

| 評価項目 | 自社開発 | Firebase Crashlytics | Sentry | 総合評価 |
|---------|---------|-------------------|--------|---------|
| 導入コスト | 高 | 低 | 中 | Crashlytics優位 |
| カスタマイズ性 | 高 | 低 | 中 | 自社開発優位 |
| セキュリティ | 高（要実装） | 中 | 中 | 自社開発優位 |
| 運用負荷 | 高 | 低 | 低 | Crashlytics優位 |
| プライバシー保護 | 高 | 中 | 中 | 自社開発優位 |

12.2 推奨構成

ハイブリッド構成
- ローカルログ: 自社開発（AsyncStorage + 暗号化）- 実装済み基盤活用
- クラッシュレポート: Firebase Crashlytics
- エラー監視: Sentry（匿名化後）
- パフォーマンス監視: 自社開発

検証計画
1. フェーズ1: 既存のログ管理機能の拡張・改善
2. フェーズ2: Firebase Crashlyticsの導入・検証
3. フェーズ3: Sentryとの連携検証
4. フェーズ4: 統合テスト・セキュリティ検証
5. フェーズ5: 本番運用開始・監視体制確立

12.3 検証項目詳細

機能検証項目
- [x] ログ出力機能の正常動作確認（ErrorHandler実装済み）
- [x] ローテーション機能の動作確認（件数ベース実装済み）
- [ ] 容量制限機能の動作確認（時間ベース・容量ベース）
- [ ] 暗号化機能の動作確認
- [ ] 異常時の動作確認

性能検証項目
- [ ] ログ出力がアプリ性能に与える影響測定
- [ ] メモリ使用量の監視・制御確認
- [ ] バッテリー消費量の測定・評価
- [ ] ストレージ使用量の最適化確認

セキュリティ検証項目
- [ ] 個人情報保護機能の確認
- [ ] 暗号化強度の検証
- [ ] アクセス制御機能の確認
- [ ] データ漏洩防止機能の確認
- [ ] プライバシー要件準拠確認

13. 実装状況まとめ

13.1 現在実装済み機能

| 機能分類 | 機能名 | 実装状況 | ファイル |
|---------|--------|----------|---------|
| エラーログ管理 | エラーログ保存・取得・削除 | ✅ 完全実装 | ErrorHandler.tsx |
| 通知履歴管理 | 通知履歴保存・取得・削除 | ✅ 完全実装 | NotificationService.ts |
| API通信管理 | 基本エラーハンドリング | 🔄 部分実装 | apiClient.ts |
| ログローテーション | 件数ベース自動削除 | ✅ 実装済み | ErrorHandler.tsx, NotificationService.ts |

13.2 今後の実装予定

短期（1-3ヶ月）
- 時間ベースログローテーション
- 容量監視・制御機能
- 設定画面からのログ管理機能

中期（3-6ヶ月）
- 暗号化機能強化
- Firebase Crashlytics統合
- パフォーマンス監視機能

長期（6ヶ月以降）
- Sentry連携
- 高度な分析・レポート機能
- AI/ML を活用した異常検知

---

文書管理情報

- 作成日: 2025-08-08
- 作成者: システム設計チーム
- 承認者: プロジェクトマネージャー
- バージョン: 1.0
- 次回見直し予定: 2025-11-08
- 関連文書: 
  - ログ管理方式概要設計書_別紙_ログ管理対象一覧.md
  - /HDBApp/src/utils/ErrorHandler.tsx
  - /HDBApp/src/services/NotificationService.ts
  - /HDBApp/src/services/api/apiClient.ts
  - スマホアプリ単体_非機能要求.tsv