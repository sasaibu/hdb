ログ管理方式概要設計書

Health Data Bank (HDB) モバイルアプリケーション

| 版数 | 版改訂日 | 変更箇所 | 変更理由 | 変更内容 | 変更者 | 承認者 |
|------|----------|----------|----------|----------|--------|--------|
| 1.0 | 2025/08/08 | 初版発行 | HDBアプリログ管理方式策定 | ログ管理方式概要設計書作成 | システム設計チーム | プロジェクトマネージャー |

---

1. 管理要求

　HDBモバイルアプリケーションにおけるログ管理では、以下の要求を満たす必要がある。

(1) 機能要求
　アプリケーション稼働時のエラー情報、API通信ログ、ユーザー認証ログ、パフォーマンス監視ログ、データ同期ログの記録を行う。エラー発生時の迅速な原因特定、セキュリティインシデント発生時の監査証跡確保を可能とする。

(2) 非機能要求
　CPU使用率50%以下、メモリ使用量200MB以下を維持し、ログ出力がアプリケーション性能に与える影響を最小化する。デバイスストレージ容量を圧迫しないようログファイルサイズを制御し、ログ検索・参照処理の応答時間を1秒以内に確保する。

(3) セキュリティ要求
　個人情報及び機密情報のログ記録を禁止し、保存データのAES256暗号化、ログ転送時のTLS1.3暗号化を実施する。ログファイルへの不正アクセスを防止する。

2. 管理方針

　基本方針として、モバイル端末のリソース制約を考慮し、必要最小限のログのみ収集する。現在はAsyncStorageによる基本的なログ管理を実装済みであり、デバイス内ログ総容量は最大100MBとする。

(1) ログレベル管理
　ERROR：アプリケーション障害・重要なエラー情報
　WARN：警告情報・性能劣化要因  
　INFO：一般的な動作情報・業務処理実行状況
　DEBUG：開発・テスト時のデバッグ情報（本番環境では無効）

(2) 環境別設定
　本番環境：ERRORレベルのみ記録、個人情報記録禁止
　テスト環境：WARN以上を記録、テスト用データのみ
　開発環境：全レベルを記録、詳細なデバッグ情報を含む

(3) プライバシー保護方針
　個人識別可能情報（PII）のログ記録を原則禁止し、必要に応じてハッシュ化・匿名化処理を実施する。医療情報・バイタルデータの生値記録を禁止する。

3. 管理対象ログ一覧

　管理対象のログ一覧を洗い出し、以下の観点で一覧を作成する。
　1) ログローテーション：ログごとにローテーションの方式を記載する
　2) ログ削除：ログごとに削除する方式やディスク上での保存期間を記載する  
　3) バックアップ：バックアップ対象となるログと、バックアップ媒体上での保存期間を記載する
　4) 容量：ディスク容量や、バックアップ媒体の容量を見積もるための基礎数値となる各ログの容量を明確化する

管理対象ログ一覧については、別紙「ログ管理方式概要設計書_別紙_ログ管理対象一覧」参照。

4. 管理対象ログ容量

　基本方針として、モバイル端末のストレージ容量制限を考慮し、効率的なログ容量管理を実施する。

(1) 容量見積もり
　本番環境（1ユーザー）：1日あたり20MB、月間600MB、年間7GB
　開発環境：1日あたり1.1GB、月間33GB、年間400GB
　CI/CDサーバー：1日あたり510MB、月間15GB、年間180GB

(2) 現在の実装状況による容量内訳
　エラーログ：最大50件 × 約5KB = 250KB（実装済み）
　通知履歴：メモリ内50件（永続化なし、実装済み）
　console出力：開発時のみ、容量制限なし
　合計ストレージ：約250KB/端末（本番環境）

(3) 容量監視・制御
　警告閾値：総容量80MB（80%使用）
　危険閾値：総容量90MB（90%使用）  
　緊急削除閾値：総容量95MB（95%使用）
　現在の制御方式として、エラーログ・通知履歴ともに50件上限で古いエントリを自動削除する。

5. ログローテーション方式

　基本方針として、モバイル環境では従来のlogrotateコマンドではなく、AsyncStorageベースの件数管理方式を採用する。

(1) 実行方法
　React Nativeアプリケーション内のJavaScriptコードにて、AsyncStorageへのログエントリ追加時に自動実行する。

```javascript
async function addLogEntry(logType, logEntry) {
  const logs = await getStoredLogs(logType);
  logs.push(logEntry);
  
  // 件数制限チェック
  const maxCount = getMaxLogCount(logType);
  if (logs.length > maxCount) {
    logs.splice(0, logs.length - maxCount);
  }
  
  await AsyncStorage.setItem(logType, JSON.stringify(logs));
}
```

(2) 実行ユーザ
　アプリケーションプロセス権限にて実行する。

(3) 実行契機
　ログエントリの新規追加時に実行する。

(4) ローテーション設定
　エラーログ：件数ベース、最新50件保持
　通知履歴：件数ベース、最新50件保持
　API通信ログ：開発時のみ、制限なし
　デバッグログ：開発時のみ、制限なし

6. ログバックアップ方式

　基本方針として、モバイル環境の制約を考慮し、重要ログのみをクラウド同期対象とする。

(1) バックアップ方法
　AsyncStorageはOS標準バックアップ（iOS iCloud、Android Google Drive）の対象となる。

(2) バックアップ対象
　対象：エラーログ、クラッシュログ（個人情報除去後）
　非対象：デバッグログ、パフォーマンスログ、個人情報を含むログ

(3) バックアップ契機
　OS標準のバックアップスケジュールに従い自動実行される。

(4) 復旧方式
　アプリ再インストール時にOS標準の復元機能により自動復旧する。手動復旧機能として、設定画面からの復旧実行機能を将来実装予定。

7. セキュリティ

　基本方針として、個人情報保護法・GDPR準拠を前提とし、ログファイルの暗号化および不正アクセス防止を実施する。

(1) データ保護
　ログファイルのAES-256暗号化を実施し、iOS Keychain・Android Keystoreを活用する。個人情報・機密情報の記録を禁止する。

(2) 伝送時セキュリティ
　TLS 1.3による通信暗号化、証明書ピンニング実装、中間者攻撃対策を実施する。

(3) アクセス制御
　開発者のみログファイルアクセス可能とし、運用担当者は匿名化ログのみ参照可能とする。ユーザーは自身のログ削除権限を保有する。

(4) プライバシー保護
　個人識別情報（PII）のマスキング処理、IPアドレス・デバイスIDの匿名化、位置情報の記録禁止を実施する。

8. システム基盤制御機能

　基本方針として、ログ管理がアプリケーション性能に与える影響を最小化する制御機能を実装する。

(1) ログ出力制御機能
　環境別ログレベル制御を実装し、パフォーマンス影響を最小化する。動的ログレベル変更機能を将来実装予定。

(2) ストレージ管理機能
　自動容量監視・制御（件数ベース実装済み）を実装し、緊急時ログ削除機能を将来実装予定。ストレージ使用量最適化を実施する。

(3) 障害時制御機能
　ログ出力失敗時の代替処理（ErrorBoundary実装済み）、無限ループ防止機能、メモリリーク防止機能を実装する。

(4) パフォーマンス制御
　ログ出力の非同期化、バックグラウンド処理による影響軽減、UIスレッドブロック防止を実施する。メモリ使用量監視・制御、CPU使用率制限機能、バッテリー消費最適化を実装する。

9. 運用作業支援ツール

　基本方針として、開発・運用効率化のためのログ監視・分析ツールを段階的に整備する。

(1) 現在利用可能な監視機能
　console出力による開発時監視、ErrorBoundaryによるクラッシュ監視、AsyncStorageのログ蓄積状況確認を実装済み。

(2) 実装済み機能
　手動ログ取得機能（getErrorLogs()）、手動ログクリア機能（clearErrorLogs()）、テスト実行時のログ確認機能を実装済み。

(3) 将来実装予定の機能
　エラー発生率監視ダッシュボード、パフォーマンス指標可視化、アラート通知機能、定期レポート自動生成、異常検知時の自動通知を将来実装予定。

(4) ユーザーサポート機能
　ログ削除機能（設定画面）、ストレージ使用量表示、プライバシー設定管理、匿名化ログ参照機能、問い合わせ時のログ確認、障害解析支援機能を将来実装予定。

10. ログ管理標準

　基本方針として、構造化されたJSONフォーマットを使用し、必要最小限の情報のみ記録する。

(1) ログフォーマット標準
　共通フォーマットとして、timestamp、level、category、message、userId（ハッシュ化）、sessionId、deviceInfo（platform、version、osVersion）、additionalを含むJSONフォーマットを使用する。

(2) 実装済みエラーログフォーマット
　timestamp、error（name、message、stack）、errorInfo、userAgentを含むJSONフォーマットを実装済み。

(3) 出力規則
　必要最小限の情報のみ記録し、個人情報・機密情報の記録を禁止する。構造化されたJSONフォーマット使用（一部実装済み）、タイムスタンプはUTC形式で統一（実装済み）する。

(4) 性能考慮事項
　ログ出力がメインスレッドをブロックせず、大量ログ出力時の制御機能（件数制限実装済み）、メモリリーク防止対策を実装する。

11. 製品検討

　基本方針として、自社開発とサードパーティ製品のハイブリッド構成を採用し、段階的に検証・導入を進める。

(1) モバイルアプリ向けログ管理サービス比較
　Firebase Crashlytics：クラッシュレポート特化、Google製品、無料、HDB適用可能
　Sentry：エラートラッキング、多言語対応、有料、HDB適用可能
　Bugsnag：エラー監視、詳細な分析機能、有料、HDB適用可能
　Rollbar：リアルタイムエラー監視、有料、HDB適用可能

(2) 自社開発 vs サードパーティ比較
　導入コスト：Crashlytics優位（無料）
　カスタマイズ性：自社開発優位（高カスタマイズ性）
　セキュリティ：自社開発優位（要実装だが高セキュリティ）
　運用負荷：Crashlytics優位（低運用負荷）
　プライバシー保護：自社開発優位（完全制御可能）

(3) 推奨構成（ハイブリッド構成）
　ローカルログ：自社開発（AsyncStorage + 暗号化）- 実装済み基盤活用
　クラッシュレポート：Firebase Crashlytics
　エラー監視：Sentry（匿名化後）
　パフォーマンス監視：自社開発

(4) 検証計画
　フェーズ1：既存のログ管理機能の拡張・改善
　フェーズ2：Firebase Crashlyticsの導入・検証
　フェーズ3：Sentryとの連携検証
　フェーズ4：統合テスト・セキュリティ検証
　フェーズ5：本番運用開始・監視体制確立

(5) 検証項目
　機能検証：ログ出力機能の正常動作確認（ErrorHandler実装済み）、ローテーション機能の動作確認（件数ベース実装済み）、容量制限機能の動作確認（時間ベース・容量ベース）、暗号化機能の動作確認、異常時の動作確認
　性能検証：ログ出力がアプリ性能に与える影響測定、メモリ使用量の監視・制御確認、バッテリー消費量の測定・評価、ストレージ使用量の最適化確認
　セキュリティ検証：個人情報保護機能の確認、暗号化強度の検証、アクセス制御機能の確認、データ漏洩防止機能の確認、プライバシー要件準拠確認

---

文書管理情報

作成日：2025-08-08
作成者：システム設計チーム
承認者：プロジェクトマネージャー
バージョン：1.0
次回見直し予定：2025-11-08
関連文書：ログ管理方式概要設計書_別紙_ログ管理対象一覧.md、/HDBApp/src/utils/ErrorHandler.tsx、/HDBApp/src/services/NotificationService.ts、/HDBApp/src/services/api/apiClient.ts、スマホアプリ単体_非機能要求.tsv