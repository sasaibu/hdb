# オンライン処理ディシジョンテーブル 設計根拠書

## 文書情報
- **文書名**: オンライン処理ディシジョンテーブル設計根拠書
- **作成日**: 2025-08-01
- **作成者**: HDBプロジェクトチーム
- **関連文書**: オンライン処理方針概要設計書、非機能要件書

## 1. 設計思想

### 1.1 3層構造の採用理由

本ディシジョンテーブルは以下の3層構造で設計しました：

1. **単項目チェック（第1層）**
2. **相関項目チェック（第2層）**
3. **セキュリティチェック（第3層）**

#### 採用根拠

**処理効率の最適化**
- 計算コストの低い単純なチェックから実行
- 不要なDB照合やAPI呼び出しを削減
- 例：パスワード未入力の場合、認証APIを呼ばずに即座にエラー

**エラーメッセージの最適化**
- ユーザーが最も理解しやすく、修正しやすいエラーを優先表示
- 「パスワードは8文字以上で入力してください」＞「認証に失敗しました」

**セキュリティ考慮**
- 攻撃者に有益な情報を与えない
- 基本的な入力検証をパスした後にセキュリティチェック

## 2. 閾値設計の根拠

### 2.1 性能関連の閾値

#### API応答時間
| 閾値 | 値 | 根拠 |
|------|-----|------|
| 正常 | 2秒以内 | 非機能要件書の目標値（95%ile） |
| 警告 | 2-30秒 | ユーザー待機の限界を考慮 |
| エラー | 30秒超 | HTTPタイムアウトの一般的な設定値 |

**設計意図**：
- 2-30秒の間は進捗表示により離脱を防止
- 30秒超えは異常事態として処理中断

#### メモリ使用量
| 閾値 | 値 | 根拠 |
|------|-----|------|
| 正常 | 150MB以下 | 上限値の75%（早期警告） |
| 警告 | 150-200MB | 上限値に接近 |
| エラー | 200MB超 | 非機能要件書の上限値 |

**設計意図**：
- 低スペック端末（RAM 2GB）でも安定動作
- 段階的な警告でクラッシュを未然防止

#### CPU使用率
| 閾値 | 値 | 根拠 |
|------|-----|------|
| 正常 | 40%以下 | 他アプリとの共存を考慮 |
| 警告 | 40-50% | 非機能要件の上限に接近 |
| エラー | 50%超 | 非機能要件書の上限値 |

### 2.2 リソース関連の閾値

#### バッテリー残量
| 閾値 | 値 | 根拠 |
|------|-----|------|
| 正常 | 20%以上 | 一般的な省電力モード開始値 |
| 警告 | 5-20% | 最低限の記録は継続 |
| エラー | 5%未満 | 緊急時のみ動作 |

**設計意図**：
- 健康データの記録を最優先
- 段階的に非必須機能を制限

#### 通信量
| 閾値 | 値 | 根拠 |
|------|-----|------|
| 正常 | 40MB/日以下 | 目標値の80% |
| 警告 | 40-50MB/日 | 非機能要件の上限に接近 |
| エラー | 50MB/日超 | 非機能要件書の上限値 |

#### ストレージ空き容量
| 閾値 | 値 | 根拠 |
|------|-----|------|
| エラー | 100MB未満 | 最低限の動作に必要 |
| 警告 | 100MB-1GB | キャッシュ削除を推奨 |
| 正常 | 1GB以上 | 非機能要件書の推奨値 |

## 3. エラー処理の設計原則

### 3.1 グレースフルデグラデーション

**原則**：完全停止ではなく、機能制限により継続性を確保

**実装例**：
- 通信エラー → オフラインモードで基本機能継続
- メモリ不足 → キャッシュクリアして継続
- API遅延 → ローカルデータで表示

### 3.2 段階的エスカレーション

1. **情報提供レベル**
   - 処理継続 ＋ 情報メッセージ
   - 例：「同期は後で実行されます」

2. **警告レベル**
   - 処理継続 ＋ 推奨アクション提示
   - 例：「メモリ使用量が多いです。他のアプリを終了することを推奨します」

3. **エラーレベル**
   - 機能制限 ＋ 必須アクション要求
   - 例：「ストレージ容量が不足しています。空き容量を確保してください」

4. **致命的レベル**
   - 安全な停止
   - 例：「セキュリティ上の問題を検出しました」

## 4. セキュリティチェックの設計

### 4.1 ルート化/Jailbreak検出

**実装理由**：
- 医療データを扱うアプリとして端末の完全性が必須
- 改竄されたOSでは暗号化機能が無効化される可能性

### 4.2 証明書検証（2段階）

**エラーレベル**：
- 明らかな偽装証明書 → 即座に接続拒否

**警告レベル**：
- 期限切れ間近
- 自己署名証明書（開発環境）

### 4.3 不正アクセス検知

**設計値**：
- ログイン失敗5回 → 一時ロック
- 根拠：一般的なタイプミスの許容範囲内

**異常パターン検知**：
- 短時間での大量アクセス
- 通常と異なる時間帯/地域からのアクセス

## 5. 実装考慮事項

### 5.1 拡張性の確保

- ルール番号を1-50まで用意
- 将来の要件追加に対応
- 優先度順の実装が可能

### 5.2 テスタビリティ

- Y/-/X記法により自動テスト生成が容易
- 各ルールが独立してテスト可能
- カバレッジ測定が明確

### 5.3 保守性

- 条件とアクションの対応が明確
- 閾値の変更が容易
- ログ出力との対応付けが可能

## 6. 医療系アプリとしての特別な考慮

### 6.1 データ保護優先

- 通信エラー時もローカル保存で記録継続
- 暗号化エラー時は記録を停止（平文保存を防ぐ）

### 6.2 可用性の確保

- 24時間365日の記録を想定
- 最小限の機能でも動作継続
- 自動復旧機能の実装

### 6.3 監査対応

- すべてのエラーイベントをログ記録
- ユーザー操作の追跡可能性
- インシデント発生時の原因究明

## 7. まとめ

本ディシジョンテーブルは、HDBアプリが医療系アプリケーションとして要求される高い信頼性とユーザビリティを両立させるために設計されました。非機能要件を基に、実運用を想定した現実的な閾値を設定し、段階的なエラー処理により、ユーザーエクスペリエンスを損なうことなく、安全で安定したサービスを提供します。