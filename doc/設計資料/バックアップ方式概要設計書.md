バックアップ方式概要設計書

システムアーキテクチャ概要設計書

バックアップ方式概要設計書

---

| 版数 | 版改訂日 | 変更箇所 | 変更理由 | 変更内容 | 変更者 | 承認者 |
|------|----------|----------|----------|----------|--------|--------|
| 1.0  | 2024/08/14 | 初版発行 | - | - | - | - |
|      |            |          |          |          |        |        |
|      |            |          |          |          |        |        |
|      |            |          |          |          |        |        |

---

目次

第1章. バックアップ／リカバリ設計方針 ........................ 1
1.1. バックアップ・リカバリ設計方針 ........................... 2
1.2. バックアップ対象一覧 ........................................ 3

第2章. バックアップ・リカバリ方式 ............................ 4
2.1. バックアップ・リカバリ方式 ................................. 5
2.1.1. HDBアプリバックアップ・リカバリ方式 .................... 6
2.1.1.1. バックアップ方式 ........................................ 7
2.1.1.2. リカバリ方式 ............................................ 9

第3章. 媒体管理方式 ........................................... 11
3.1. 媒体管理方式 .............................................. 12

第4章. ストレージ設計 ......................................... 13
4.1. 設計方針 .................................................. 14
4.2. 設計方式 .................................................. 15
4.2.1. ストレージ構成一覧 ....................................... 15
4.2.2. 必要なストレージ容量 ..................................... 15
4.2.3. 必要なストレージ機能 ..................................... 16
4.2.4. システム構成 ............................................. 17
4.2.5. ソフトウェア構成 ......................................... 18
4.2.6. ライブラリ構成 ........................................... 19

---

第1章. バックアップ／リカバリ設計方針

1.1. バックアップ・リカバリ設計方針

目的
本設計書は、Health Data Bank（HDB）モバイルアプリケーションシステムの稼働に必要なデータ、重要なデータが紛失しないためのデータのバックアップ／リカバリの仕組みについて網羅的に整理し、検証可能にすることを目的とする。

基本方針
1. ユーザーデータ保護：モバイルアプリ内のユーザーの健康データの完全性を保証する
2. アプリレベルでの復旧：アプリ削除・端末交換時の迅速なデータ復旧を実現する
3. 簡易な運用：ユーザーが手動実行できるバックアップ・リストア機能を提供する
4. プライバシー保護：バックアップデータの暗号化及び個人情報保護

適用範囲
- HDBモバイルアプリケーション（iOS/Android）
- アプリ内SQLiteデータベース（hdb.db）
- AsyncStorage設定データ
- Keychainに保存される認証情報

設計原則
- RPO（Recovery Point Objective）：手動バックアップ実行時点
- RTO（Recovery Time Objective）：アプリ復旧目標時間 30分以内
- バックアップ世代管理：ユーザー判断による手動管理
- セキュリティ：バックアップデータの暗号化及びバックアップIDによる管理

1.2. バックアップ対象一覧

| No. | バックアップ対象 | 対象データ | 重要度 | バックアップ方式 | 保存場所 |
|-----|------------------|------------|--------|------------------|----------|
| 1   | SQLiteデータベース | hdb.db（vital_data、targets、daily_heart_rate等） | 高 | 手動実行 | API経由でサーバー側 |
| 2   | アプリ設定データ | AsyncStorage保存データ | 中 | 手動実行 | API経由でサーバー側 |
| 3   | 認証トークン | Keychain保存データ | 高 | 除外対象 | - |
| 4   | 一時キャッシュ | アプリ内キャッシュファイル | 低 | 除外対象 | - |

---

第2章. バックアップ・リカバリ方式

2.1. バックアップ・リカバリ方式

全体アーキテクチャ
HDBモバイルアプリケーションのバックアップ・リカバリシステムは、以下の構成で実装される：

1. アプリ層：React Nativeアプリ内のバックアップ機能（BackupScreen）
2. データ層：SQLiteデータベース（DatabaseService）、AsyncStorage
3. API層：バックアップ・リストア用APIエンドポイント
4. サーバー側ストレージ：バックアップデータの保存先

現在の実装状況
実装済み機能
- BackupScreen：ユーザーが手動でバックアップを実行する画面
- DatabaseService：SQLiteデータベース操作サービス
- apiClient：バックアップ・リストア用API（createBackup、restoreBackup）
- データベーステーブル：vital_data、targets、daily_heart_rate

実装予定機能
- AsyncStorage データのバックアップ
- リストア画面（RestoreScreen）
- バックアップ履歴管理

2.1.1. HDBアプリバックアップ・リカバリ方式

システム構成概要
HDBアプリケーションのバックアップシステムは、React Nativeアプリ内の手動バックアップ機能として実装されており、APIを通じてサーバー側にデータを保存する。

2.1.1.1. バックアップ方式

手動バックアップ処理フロー

1. ユーザー操作フェーズ
```
1. BackupScreen画面でユーザーが「バックアップの実行」ボタンを押下
2. 確認ダイアログで「開始」を選択
3. ローディング状態でバックアップ処理開始
```

2. データ収集フェーズ
```
1. DatabaseService経由でSQLiteデータベース（hdb.db）からデータ取得
   - vital_data テーブル（バイタルデータ）
   - targets テーブル（目標値データ）
   - daily_heart_rate テーブル（日次心拍データ）
2. AsyncStorageからアプリ設定データ取得（予定）
3. データ整合性チェック実行
```

3. API送信フェーズ
```
1. apiClient.createBackup()実行
2. 収集データをJSONフォーマットでAPI送信
3. サーバー側でデータ保存・バックアップID生成
4. レスポンスでバックアップ情報取得
```

4. 結果表示フェーズ
```
1. バックアップ成功時：バックアップID、サイズ、作成日時を表示
2. バックアップ失敗時：エラーメッセージ表示
3. ユーザーにバックアップIDの安全な保管を案内
```

バックアップ方式詳細

手動フルバックアップ
- 実行タイミング：ユーザーが任意に実行
- 対象データ：SQLiteデータベース全体、AsyncStorage設定
- 処理時間：約30秒-2分（データ量により変動）
- バックアップ形式：JSON形式でAPI送信

バックアップ品質保証

データ整合性チェック
1. 事前チェック：DatabaseService初期化状態確認
2. データ取得検証：SQLクエリ実行結果の妥当性確認
3. API通信確認：サーバーレスポンスの成功ステータス確認

エラーハンドリング
- ネットワークエラー：apiClientのタイムアウト・リトライ機能
- データベースエラー：SQLite操作エラーの適切なキャッチ
- API エラー：サーバーエラーレスポンスの表示

2.1.1.2. リカバリ方式

リストアシナリオ

1. 新端末でのデータ復元
対象：端末交換時の全データ復元
手順：
1. 新端末でHDBアプリをインストール・初期設定
2. RestoreScreen（実装予定）でバックアップIDを入力
3. apiClient.restoreBackup(backupId)実行
4. サーバーからバックアップデータを取得
5. DatabaseService経由でSQLiteデータベースに復元
6. AsyncStorageに設定データ復元
7. アプリ再起動・動作確認

2. アプリ再インストール時の復元
対象：同一端末でのアプリ削除後復元
手順：
1. HDBアプリ再インストール
2. ログイン認証実行
3. バックアップIDを用いたリストア実行
4. データ整合性確認
5. 通常操作の動作確認

3. 部分データ復元（将来実装）
対象：特定期間またはデータ種別の選択復元
手順：
1. 復元対象データの選択
2. 該当データのみAPIから取得
3. 既存データベースへの追加またはマージ
4. データ重複チェック・整合性確認

リストア時間目標

| 復旧レベル | 目標時間 | 復旧データ範囲 |
|------------|----------|----------------|
| 基本復旧   | 10分以内 | 重要バイタルデータ |
| 完全復旧   | 30分以内 | 全データ・設定 |

リストア品質保証

復旧データ検証
1. データベース整合性確認：復旧後のSQLiteテーブル構造・データ確認
2. アプリ機能動作確認：主要画面の正常表示・操作確認
3. データ表示確認：バイタルデータの正しい表示確認

実装済み検証機能
- DatabaseService.getAllData()：全データ取得による整合性確認
- エラーハンドリング：API通信エラー・データベースエラーの適切な処理

---

第3章. 媒体管理方式

3.1. 媒体管理方式

サーバーサイドストレージ構成

プライマリストレージ
- 種類：HDB APIサーバー内データベース
- 暗号化：データベースレベル暗号化
- アクセス制御：APIキーベース認証
- バックアップ形式：JSONフォーマット

モバイルアプリ側ストレージ
- メインストレージ：SQLiteデータベース（hdb.db）
- 設定ストレージ：AsyncStorage
- セキュアストレージ：Keychain（iOS）/ Android Keystore（Android）
- 一時ストレージ：アプリ内キャッシュ

データ保管ポリシー

ユーザー管理バックアップ
- 保存期間：ユーザーが手動で管理
- 世代数：ユーザーの判断による
- アクセス方法：バックアップIDによる特定

システム管理データ
- アプリログ：ローカルファイルシステムに一時保存
- クラッシュレポート：Crashlytics等外部サービス連携
- デバッグ情報：開発時のみローカル保存

バックアップ対象外データ

セキュリティ情報
- 認証トークン：バックアップ対象外（セキュリティ上の理由）
- 生体認証情報：バックアップ対象外
- パスワードハッシュ：バックアップ対象外

一時データ
- キャッシュファイル：アプリ再起動時に再生成可能
- 一時画像ファイル：サーバーから再取得可能
- ログファイル：デバッグ用途のみ

---

第4章. ストレージ設計

4.1. 設計方針

モバイルアプリファースト戦略
HDBモバイルアプリケーションでは、従来のサーバーサイドバックアップに代わり、APIベースのユーザーデータバックアップを採用する。これにより、以下の利点を実現する：

1. ユーザー主導：ユーザーが任意のタイミングでバックアップ実行
2. 簡単な運用：複雑なスケジューリングや管理不要
3. プライバシー保護：ユーザーがバックアップタイミングを制御
4. ポータビリティ：端末間でのデータ移行が容易

4.2. 設計方式

4.2.1. ストレージ構成一覧

現在のHDBアプリケーションでは、以下のストレージ構成を使用：

| No. | ストレージ種類 | 用途 | 容量 | バックアップ対象 |
|-----|------------|------|------|---------| 
| 1   | SQLiteデータベース | メインデータストレージ | 約100MB/ユーザー | ○ |
| 2   | AsyncStorage | アプリ設定ストレージ | 約10MB/ユーザー | ○（予定） |
| 3   | Keychain | セキュアストレージ | 約10KB/ユーザー | × |
| 4   | アプリキャッシュ | 一時ストレージ | 約50MB/ユーザー | × |

4.2.2. 必要なストレージ容量

ユーザーデータバックアップ容量計画：

容量見積もり
- 想定ユーザー数：1,000ユーザー（初期）～ 10,000ユーザー（将来）
- 1ユーザー当たりSQLiteデータ量：平均100MB（年間データ）
- 1ユーザー当たり設定データ量：平均5MB
- バックアップ縮減率：約70%（JSON圧縮）

API通信容量計算
```
1ユーザーバックアップサイズ：(100MB + 5MB) × 0.7 = 73.5MB
1,000ユーザー総容量：73.5MB × 1,000 = 73.5GB
10,000ユーザー総容量：73.5MB × 10,000 = 735GB
```

4.2.3. 必要なストレージ機能

モバイルアプリバックアップ要求機能：

基本機能
1. データ数値化：SQLiteデータのJSON変換
2. API送信：HTTPS通信によるセキュアなデータ送信
3. ユーザー認証：バックアップ実行者の身元確認
4. エラーハンドリング：ネットワークエラーの適切な処理

実装済み機能
1. DatabaseService：SQLiteデータベース操作の統一インターフェース
2. apiClient：バックアップAPI呼び出し機能
3. BackupScreen：ユーザーインターフェース
4. エラー表示：バックアップ失敗時のユーザー通知

4.2.4. システム構成

HDBアプリバックアップシステム構成：

クライアントサイド（React Nativeアプリ）
- プラットフォーム：iOS 14+、Android 8+
- データベース：react-native-sqlite-2
- ストレージ：@react-native-async-storage/async-storage
- ネットワーク：fetch API、HTTPS通信

サーバーサイド
- APIサーバー：HDBバックエンドシステム
- データベース：ユーザーバックアップデータ管理
- 認証：ユーザー認証システム連携
- ストレージ：バックアップデータ保存用ストレージ

4.2.5. ソフトウェア構成

バックアップソフトウェアスタック：

アプリケーション層
- UIコンポーネント：BackupScreen（実装済み）、RestoreScreen（予定）
- サービス層：DatabaseService、apiClient
- データ層：SQLite、AsyncStorage、Keychain

ライブラリスタック
- データベース：react-native-sqlite-2
- ストレージ：@react-native-async-storage/async-storage
- セキュアストレージ：react-native-keychain
- HTTPクライアント：fetch API

アプリ内サービス
- バックアップサービス：ユーザーデータ収集・送信
- リストアサービス：バックアップデータ復元
- エラーハンドリング：例外処理・ユーザー通知

4.2.6. ライブラリ構成

現在実装されているライブラリ一覧：

コアライブラリ
```typescript
// データベース操作
import SQLite from 'react-native-sqlite-2';

// ストレージ操作
import AsyncStorage from '@react-native-async-storage/async-storage';
import Keychain from 'react-native-keychain';

// UIコンポーネント
import React, { useState } from 'react';
import { View, Text, TouchableOpacity, Alert } from 'react-native';
```

バックアップ関連サービス
```typescript
// データベースサービス
import { DatabaseService } from '../services/DatabaseService';

// APIクライアント
import { apiClient } from '../services/api/apiClient';

// モックAPI（開発用）
import { mockApi } from '../services/api/mockApi';
```

タイプ定義
```typescript
// バックアップデータ型
interface VitalDataRecord {
  id?: number;
  type: string;
  value: number;
  unit: string;
  recorded_date: string;
  // ...
}
```

---

付録

A. バックアップ実装状況
- 実装済み：BackupScreen、DatabaseService、apiClient（モック）
- 実装予定：RestoreScreen、AsyncStorageバックアップ、実APIクライアント

B. データベーステーブル構成
- vital_data：バイタルデータ（歩数、体重、体温、血圧、心拍数）
- targets：目標値設定
- daily_heart_rate：日次心拍データ

C. API仕様（予定）
- POST /api/sync/backup：バックアップ作成
- POST /api/sync/restore：バックアップ復元

D. 用語集
- SQLite：モバイルアプリ用軽量データベース
- AsyncStorage：React Native用非同期ストレージ
- Keychain：iOS/Android用セキュアストレージ
- HDB：Health Data Bank（健康データバンク）

---

文書終了