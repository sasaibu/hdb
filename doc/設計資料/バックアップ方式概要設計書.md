# バックアップ方式概要設計書

## システムアーキテクチャ概要設計書

---

| 版数 | 版改訂日 | 変更箇所 | 変更理由 | 変更内容 | 変更者 | 承認者 |
|------|----------|----------|----------|----------|--------|--------|
| 1.0  | 2024/08/14 | 初版発行 | - | - | - | - |

---

## 目次

**第1章. バックアップ／リカバリ設計方針** ........................ 1  
1.1. バックアップ・リカバリ設計方針 ........................... 2  
1.2. バックアップ対象一覧 ........................................ 3  

**第2章. バックアップ出力設計** ................................. 4  
2.1. NW機器のバックアップ出力設計 .............................. 5  
2.2. アプリケーションバックアップ出力設計 ...................... 6  

**第3章. バックアップ管理方式設計** ............................. 9  
3.1. バックアップローテーション方式 ............................ 10  
3.2. バックアップ削除方式 ....................................... 13  
3.3. バックアップリストア方式 ................................... 15  
3.4. 管理対象バックアップ一覧 ................................... 16  

---

## 第1章. バックアップ／リカバリ設計方針

### 1.1. バックアップ・リカバリ設計方針

#### 目的
本設計書は、Health Data Bank（HDB）モバイルアプリケーションシステムの稼働に必要なデータ、重要なデータが紛失しないためのデータのバックアップ／リカバリの仕組みについて網羅的に整理し、検証可能にすることを目的とする。

#### 基本方針

##### (1) データ保護方針
- **ユーザーデータの完全性保証**：健康データの損失防止を最優先とする
- **迅速な復旧**：アプリ削除・端末交換時の30分以内での完全復旧
- **ユーザー主導型**：ユーザーが任意のタイミングでバックアップ実行可能
- **セキュリティ確保**：暗号化による個人情報保護

##### (2) バックアップレベル
- **レベル1（基本バックアップ）**：SQLiteデータベース（vital_data、targets、daily_heart_rate）
- **レベル2（設定バックアップ）**：AsyncStorage設定データ（実装予定）
- **レベル3（除外データ）**：認証トークン、生体認証情報、一時キャッシュ

##### (3) 復旧目標
- **RPO（Recovery Point Objective）**：手動バックアップ実行時点
- **RTO（Recovery Time Objective）**：基本復旧10分、完全復旧30分
- **データ整合性**：100%（バックアップ時点のデータ完全復元）

##### (4) 適用範囲
- HDBモバイルアプリケーション（iOS 14+/Android 8+）
- React Native 0.80.0環境
- SQLiteデータベース（react-native-sqlite-2）
- AsyncStorage（@react-native-async-storage/async-storage）

### 1.2. バックアップ対象一覧

#### バックアップ対象データ分類

| No. | 対象カテゴリ | データ種別 | ファイル/テーブル | サイズ | 重要度 | バックアップ方式 | 保存先 |
|-----|-------------|-----------|------------------|--------|--------|-----------------|--------|
| 1 | ユーザーデータ | バイタルデータ | vital_data | 約50MB | 高 | 手動/API | サーバー |
| 2 | ユーザーデータ | 目標値 | targets | 約1MB | 高 | 手動/API | サーバー |
| 3 | ユーザーデータ | 心拍データ | daily_heart_rate | 約40MB | 高 | 手動/API | サーバー |
| 4 | アプリ設定 | ユーザー設定 | AsyncStorage | 約5MB | 中 | 手動/API | サーバー |
| 5 | 認証情報 | トークン | Keychain | <1KB | - | 除外 | - |
| 6 | 一時データ | キャッシュ | Cache | 約50MB | - | 除外 | - |

#### バックアップ除外データ

| No. | 除外理由 | データ種別 | 説明 |
|-----|----------|-----------|------|
| 1 | セキュリティ | 認証トークン | 再認証により取得可能 |
| 2 | セキュリティ | 生体認証情報 | 端末固有情報のため復元不可 |
| 3 | セキュリティ | パスワードハッシュ | セキュリティリスク回避 |
| 4 | 再生成可能 | キャッシュファイル | アプリ起動時に自動生成 |
| 5 | 再取得可能 | 一時画像 | サーバーから再ダウンロード可能 |

---

## 第2章. バックアップ出力設計

### 2.1. NW機器のバックアップ出力設計

#### ネットワーク構成におけるバックアップ

##### (1) 通信プロトコル
- **プロトコル**：HTTPS（TLS 1.3）
- **エンドポイント**：/api/sync/backup、/api/sync/restore
- **認証方式**：Bearer Token + バックアップID
- **データ形式**：JSON（gzip圧縮）

##### (2) ネットワーク要件
- **帯域幅**：最小1Mbps（推奨10Mbps）
- **レイテンシ**：最大500ms
- **タイムアウト**：120秒
- **リトライ**：3回（指数バックオフ）

##### (3) エラーハンドリング
```javascript
// ネットワークエラー処理
const backupWithRetry = async (data, retries = 3) => {
  for (let i = 0; i < retries; i++) {
    try {
      return await apiClient.createBackup(data);
    } catch (error) {
      if (i === retries - 1) throw error;
      await wait(Math.pow(2, i) * 1000); // 指数バックオフ
    }
  }
};
```

### 2.2. アプリケーションバックアップ出力設計

#### バックアップ処理アーキテクチャ

##### (1) 処理フロー概要
```
[ユーザー操作] → [データ収集] → [圧縮・暗号化] → [API送信] → [結果表示]
```

##### (2) 詳細処理フロー

**Phase 1: ユーザー操作**
```javascript
// BackupScreen.tsx
const handleBackup = async () => {
  setLoading(true);
  try {
    // 1. 確認ダイアログ表示
    const confirmed = await showConfirmDialog();
    if (!confirmed) return;
    
    // 2. バックアップ処理開始
    const result = await performBackup();
    
    // 3. 結果表示
    showBackupResult(result);
  } catch (error) {
    showError(error);
  } finally {
    setLoading(false);
  }
};
```

**Phase 2: データ収集**
```javascript
// DatabaseService.ts
const collectBackupData = async () => {
  const data = {
    vital_data: await db.executeSql('SELECT * FROM vital_data'),
    targets: await db.executeSql('SELECT * FROM targets'),
    daily_heart_rate: await db.executeSql('SELECT * FROM daily_heart_rate'),
    settings: await AsyncStorage.getItem('app_settings'),
    metadata: {
      version: APP_VERSION,
      created_at: new Date().toISOString(),
      device_info: getDeviceInfo()
    }
  };
  return data;
};
```

**Phase 3: データ送信**
```javascript
// apiClient.ts
const createBackup = async (data) => {
  const compressed = gzip(JSON.stringify(data));
  const encrypted = encrypt(compressed, USER_KEY);
  
  const response = await fetch(API_ENDPOINT + '/sync/backup', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/octet-stream',
      'Content-Encoding': 'gzip'
    },
    body: encrypted
  });
  
  return response.json(); // { backupId, size, createdAt }
};
```

##### (3) バックアップデータフォーマット
```typescript
interface BackupData {
  version: string;
  created_at: string;
  device_info: DeviceInfo;
  data: {
    vital_data: VitalDataRecord[];
    targets: TargetRecord[];
    daily_heart_rate: HeartRateRecord[];
    settings: AppSettings;
  };
  checksum: string;
}
```

---

## 第3章. バックアップ管理方式設計

### 3.1. バックアップローテーション方式

#### ローテーション戦略

##### (1) 世代管理方式
- **手動バックアップ**：最新3世代保持（ユーザー設定可能）
- **自動バックアップ**：なし（将来実装検討）
- **世代識別**：バックアップID + タイムスタンプ

##### (2) ローテーション実装
```javascript
// BackupRotationService.ts
class BackupRotationService {
  private readonly MAX_GENERATIONS = 3;
  
  async rotateBackups(userId: string) {
    const backups = await this.getBackupList(userId);
    
    if (backups.length > this.MAX_GENERATIONS) {
      // 古いバックアップを削除
      const toDelete = backups
        .sort((a, b) => b.createdAt - a.createdAt)
        .slice(this.MAX_GENERATIONS);
      
      for (const backup of toDelete) {
        await this.deleteBackup(backup.id);
      }
    }
  }
}
```

##### (3) 容量管理
| ユーザー数 | 1世代サイズ | 3世代合計 | サーバー容量 |
|-----------|------------|-----------|-------------|
| 1 | 73.5MB | 220.5MB | 220.5MB |
| 100 | 7.35GB | 22.05GB | 22.05GB |
| 1,000 | 73.5GB | 220.5GB | 220.5GB |
| 10,000 | 735GB | 2.2TB | 2.2TB |

### 3.2. バックアップ削除方式

#### 削除ポリシー

##### (1) 自動削除条件
- **容量超過時**：ユーザー容量上限（500MB）超過時に最古世代を削除
- **期限切れ**：最終アクセスから1年経過（設定可能）
- **アカウント削除**：ユーザーアカウント削除時に全バックアップ削除

##### (2) 手動削除
```javascript
// ユーザーによる削除操作
const deleteBackup = async (backupId: string) => {
  // 1. 確認ダイアログ
  const confirmed = await Alert.alert(
    '削除確認',
    'このバックアップを削除しますか？',
    [
      { text: 'キャンセル', style: 'cancel' },
      { text: '削除', style: 'destructive', onPress: async () => {
        // 2. API呼び出し
        await apiClient.deleteBackup(backupId);
        // 3. ローカルキャッシュクリア
        await clearBackupCache(backupId);
      }}
    ]
  );
};
```

##### (3) 削除時の検証
- **削除前確認**：バックアップIDの有効性確認
- **権限確認**：ユーザー所有権の確認
- **削除後処理**：ログ記録、容量更新

### 3.3. バックアップリストア方式

#### リストア処理設計

##### (1) リストアシナリオ別処理

**シナリオ1: 新端末への移行**
```javascript
// RestoreService.ts
const restoreToNewDevice = async (backupId: string) => {
  // 1. バックアップデータ取得
  const backupData = await apiClient.getBackup(backupId);
  
  // 2. データベース初期化
  await DatabaseService.initialize();
  
  // 3. データ復元
  await DatabaseService.restoreData(backupData.vital_data);
  await AsyncStorage.setItem('app_settings', backupData.settings);
  
  // 4. 検証
  const verified = await verifyRestoredData(backupData);
  
  return verified;
};
```

**シナリオ2: アプリ再インストール**
```javascript
const restoreAfterReinstall = async () => {
  // 1. 最新バックアップID取得
  const latestBackupId = await apiClient.getLatestBackupId();
  
  // 2. リストア実行
  return await restoreToNewDevice(latestBackupId);
};
```

##### (2) リストア時間性能目標

| データ量 | ダウンロード | 復元処理 | 検証 | 合計時間 |
|---------|-------------|---------|------|----------|
| 10MB | 10秒 | 5秒 | 2秒 | 17秒 |
| 50MB | 50秒 | 20秒 | 5秒 | 75秒 |
| 100MB | 100秒 | 40秒 | 10秒 | 150秒 |

##### (3) リストアデータ検証
```javascript
// DataVerificationService.ts
const verifyRestoredData = async (originalData) => {
  const checks = [
    // レコード数確認
    checkRecordCount(originalData),
    // チェックサム検証
    verifyChecksum(originalData),
    // データ整合性確認
    checkDataIntegrity(originalData),
    // 外部キー関係確認
    verifyRelationships(originalData)
  ];
  
  const results = await Promise.all(checks);
  return results.every(r => r === true);
};
```

### 3.4. 管理対象バックアップ一覧

#### バックアップ管理マトリックス

##### (1) データ種別管理表

| データ種別 | ローテーション | 削除方式 | 保存期間 | 圧縮率 | 暗号化 | 優先度 |
|-----------|---------------|---------|----------|--------|--------|--------|
| vital_data | 3世代 | 手動 | 無期限 | 70% | ○ | 高 |
| targets | 3世代 | 手動 | 無期限 | 80% | ○ | 高 |
| daily_heart_rate | 3世代 | 手動 | 無期限 | 65% | ○ | 高 |
| app_settings | 3世代 | 手動 | 無期限 | 90% | ○ | 中 |
| temp_cache | - | 自動 | 24時間 | - | × | 低 |

##### (2) バックアップ実行管理

| 実行種別 | 頻度 | トリガー | 実行時間帯 | 通知 | ログ |
|---------|------|---------|-----------|------|------|
| 手動バックアップ | 任意 | ユーザー操作 | 任意 | ○ | ○ |
| 自動バックアップ | - | - | - | - | - |
| 緊急バックアップ | 任意 | システム異常時 | 任意 | ○ | ○ |

##### (3) ストレージ容量計画

**現在の実装状況**
- SQLiteデータベース：最大100MB/ユーザー
- AsyncStorage：最大10MB/ユーザー
- 圧縮後サイズ：約73.5MB/ユーザー
- サーバー容量：ユーザー数 × 73.5MB × 3世代

**将来の拡張計画**
- 画像データ対応：+200MB/ユーザー
- 詳細ログ保存：+50MB/ユーザー
- 外部連携データ：+100MB/ユーザー

---

## 付録

### A. 実装状況
- **実装済み**
  - BackupScreen（バックアップ画面）
  - DatabaseService（データベース操作）
  - apiClient（モックAPI）
  - vital_data、targets、daily_heart_rateテーブル

- **実装予定**
  - RestoreScreen（リストア画面）
  - AsyncStorageバックアップ
  - 実APIクライアント
  - バックアップ履歴管理
  - 自動バックアップ機能

### B. API仕様
```yaml
# バックアップ作成
POST /api/sync/backup
Authorization: Bearer {token}
Content-Type: application/json
Body: {
  data: {...},
  device_info: {...}
}
Response: {
  backup_id: "uuid",
  size: 73500000,
  created_at: "2024-08-14T10:00:00Z"
}

# バックアップ復元
POST /api/sync/restore
Authorization: Bearer {token}
Content-Type: application/json
Body: {
  backup_id: "uuid"
}
Response: {
  data: {...},
  restored_at: "2024-08-14T11:00:00Z"
}
```

### C. エラーコード一覧
| コード | エラー名 | 説明 | 対処法 |
|--------|---------|------|--------|
| E001 | BACKUP_FAILED | バックアップ処理失敗 | リトライ実行 |
| E002 | NETWORK_ERROR | ネットワーク接続エラー | 接続確認後リトライ |
| E003 | STORAGE_FULL | ストレージ容量不足 | 古いバックアップ削除 |
| E004 | INVALID_BACKUP_ID | 無効なバックアップID | ID確認 |
| E005 | RESTORE_FAILED | リストア処理失敗 | サポート問い合わせ |

### D. 用語集
- **RPO**: Recovery Point Objective - 目標復旧時点
- **RTO**: Recovery Time Objective - 目標復旧時間
- **SQLite**: モバイル用軽量データベース
- **AsyncStorage**: React Native非同期ストレージ
- **Keychain**: iOS/Androidセキュアストレージ