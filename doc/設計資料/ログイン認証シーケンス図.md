# ログイン認証とWebview認証のシーケンス図

## 概要
HDBアプリにおけるログイン認証時のWebview認証とトークン取得の流れを示すシーケンス図です。

## シーケンス図

```mermaid
sequenceDiagram
    participant User as ユーザー
    participant App as HDBアプリ
    participant WebView as WebView
    participant HDB as HDB個人サイト
    participant AuthAPI as 認証API
    participant AWS as バイタルAWS
    
    Note over User, AWS: ログイン認証フロー
    
    User->>App: アプリ起動
    App->>App: スプラッシュ画面表示
    App->>App: 初期化処理
    
    alt 未ログイン状態
        App->>User: ログイン画面表示
        User->>App: ログイン実行
        App->>WebView: WebView画面起動
        WebView->>HDB: HDB個人サイトへアクセス
        HDB->>WebView: ログイン画面表示
        WebView->>User: ID/パスワード入力画面
        User->>WebView: ID/パスワード入力
        WebView->>HDB: 認証情報送信
        HDB->>AuthAPI: 認証API呼び出し
        AuthAPI->>AuthAPI: ID/パスワード認証処理
        
        alt 認証成功
            AuthAPI->>HDB: 認証成功レスポンス
            HDB->>WebView: 認証成功（トークン含む）
            WebView->>App: 認証結果（トークン）受け渡し
            App->>App: トークンを保存（AsyncStorage）
            App->>User: メイン画面（トップメニュー）表示
            
            Note over App, AWS: バイタルデータ連携
            App->>AWS: バイタルデータ取得API（トークン付き）
            AWS->>App: バイタルデータレスポンス
            App->>User: ダッシュボード表示（歩数等）
            
        else 認証失敗
            AuthAPI->>HDB: 認証失敗レスポンス
            HDB->>WebView: 認証エラー表示
            WebView->>User: エラーメッセージ表示
            User->>WebView: 再入力
        end
        
    else 既ログイン状態
        App->>App: 保存されたトークンを確認
        App->>AuthAPI: トークン有効性確認
        
        alt トークン有効
            AuthAPI->>App: トークン有効レスポンス
            App->>User: メイン画面（トップメニュー）表示
            
        else トークン無効
            App->>User: ログイン画面表示
            Note over User, App: 上記の未ログイン状態フローへ
        end
    end
    
    Note over User, AWS: SSO連携（外部サービス）
    User->>App: 外部サービス連携
    App->>WebView: SSO用WebView起動
    WebView->>HDB: SSO API使用してHDB画面表示
    HDB->>WebView: 連携サービス画面
    WebView->>User: サービス連携画面表示
    
    Note over User, AWS: セキュリティ機能
    User->>App: パスワードロック設定
    App->>App: パスワードロック機能
    App->>User: アプリロック画面表示
```

## 主要な認証要素

### 1. ログイン認証
- **項番1**: ID/パスワード認証（パスワードロック機能付き）
- **項番3**: スマートフォン向け認証API（クリエイティブヘルス方式）
- **項番80**: 汎用WebView画面（静的ページ/SSO API使用）

### 2. トークン管理
- WebView認証後にトークンを取得
- AsyncStorageでトークンを永続化
- トークンの有効性確認機能

### 3. 外部サービス連携
- シングルサインオン（SSO）対応
- 外部サービスへの認証連携

### 4. セキュリティ機能
- パスワードロック機能
- デバイス情報の登録・更新（項番81）

## 技術的実装ポイント

1. **WebView統合**: JavaScript呼び出しによるアプリ・WebView間の連携
2. **トークン管理**: AsyncStorageを使用した認証情報の永続化
3. **SSO対応**: 外部サービスとの認証連携
4. **エラーハンドリング**: 認証失敗時の適切な画面遷移
5. **セキュリティ**: パスワードロック機能による追加セキュリティ層

## 参考情報
- 開発対象機能一覧.tsv の項番1, 3, 80, 81を基に作成
- WebViewとJavaScriptの連携機能を活用
- 外部サービスとのSSO連携を考慮した設計