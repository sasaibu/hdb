# 通知機能詳細検証レポート（課題No.42）

## 1. 要件の詳細確認

### 1.1 ビジネス要件
- **目的**: ユーザーが目標を達成していない場合、毎日定時に通知を送る
- **通知タイミング**: ユーザーが設定した時刻（例：毎日21:00）
- **通知期間**: 無期限（ユーザーが停止するまで）
- **通知条件**: 当日の目標が未達成の場合のみ

### 1.2 技術的制約
- アプリの常駐化は不可
- アプリ起動時にスケジュール設定する方式
- バックグラウンドでの動作は許容

## 2. ローカル通知の仕組み

### 2.1 ローカル通知とは
```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   アプリ     │────>│  OS通知     │────>│   通知表示   │
│             │     │ スケジューラ │     │             │
└─────────────┘     └─────────────┘     └─────────────┘
     ↓                      ↓                    ↓
  設定時のみ            24時間365日          指定時刻に
  起動必要              稼働               自動表示
```

### 2.2 プッシュ通知との違い

| 項目 | ローカル通知 | プッシュ通知 |
|------|------------|------------|
| 送信元 | 端末内部（OS） | 外部サーバー |
| ネット接続 | 不要 | 必要 |
| 実装箇所 | クライアントのみ | サーバー＋クライアント |
| 制御 | アプリ内で完結 | サーバー側で制御 |
| コスト | 無料 | サーバー費用発生 |

## 3. 実装詳細

### 3.1 必要なライブラリ
```bash
npm install react-native-push-notification
npm install @react-native-community/push-notification-ios  # iOS用

# iOS追加設定
cd ios && pod install
```

### 3.2 プラットフォーム別の設定

#### Android設定（android/app/src/main/AndroidManifest.xml）
```xml
<uses-permission android:name="android.permission.VIBRATE" />
<uses-permission android:name="android.permission.RECEIVE_BOOT_COMPLETED"/>
<uses-permission android:name="android.permission.SCHEDULE_EXACT_ALARM" />  <!-- Android 12+ -->

<application>
    <!-- 通知チャンネル設定 -->
    <meta-data 
        android:name="com.dieam.reactnativepushnotification.notification_channel_name"
        android:value="Goal Reminders"/>
    
    <!-- ブート時の自動起動 -->
    <receiver android:name="com.dieam.reactnativepushnotification.modules.RNPushNotificationBootEventReceiver">
        <intent-filter>
            <action android:name="android.intent.action.BOOT_COMPLETED" />
        </intent-filter>
    </receiver>
</application>
```

#### iOS設定（AppDelegate.m）
```objective-c
#import <UserNotifications/UserNotifications.h>
#import <RNCPushNotificationIOS.h>

// 通知センターのデリゲート設定
- (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions
{
  // 通知センターの設定
  UNUserNotificationCenter *center = [UNUserNotificationCenter currentNotificationCenter];
  center.delegate = self;
  
  return YES;
}
```

### 3.3 実装コード

#### 改修版NotificationService
```typescript
import PushNotification, { Importance } from 'react-native-push-notification';
import AsyncStorage from '@react-native-async-storage/async-storage';
import { Platform } from 'react-native';

class EnhancedNotificationService {
  private static instance: EnhancedNotificationService;
  
  private constructor() {
    this.configure();
  }
  
  static getInstance(): EnhancedNotificationService {
    if (!EnhancedNotificationService.instance) {
      EnhancedNotificationService.instance = new EnhancedNotificationService();
    }
    return EnhancedNotificationService.instance;
  }
  
  private configure(): void {
    // PushNotificationの初期設定
    PushNotification.configure({
      // 通知がタップされた時の処理
      onNotification: function(notification) {
        console.log('NOTIFICATION:', notification);
        
        // 目標画面への遷移など
        if (notification.userInfo?.type === 'goal_reminder') {
          // NavigationService.navigate('GoalScreen');
        }
      },
      
      // iOS用の設定
      permissions: {
        alert: true,
        badge: true,
        sound: true,
      },
      
      popInitialNotification: true,
      requestPermissions: true,
    });
    
    // Android用チャンネル作成
    if (Platform.OS === 'android') {
      PushNotification.createChannel(
        {
          channelId: 'goal-reminder-channel',
          channelName: '目標リマインダー',
          channelDescription: '毎日の目標達成確認通知',
          importance: Importance.HIGH,
          vibrate: true,
        },
        (created) => console.log(`Channel created: ${created}`)
      );
    }
  }
  
  /**
   * 無期限の毎日通知をスケジュール
   */
  async scheduleUnlimitedDailyGoalReminder(
    hour: number,
    minute: number,
    checkGoalFunction?: () => Promise<boolean>
  ): Promise<void> {
    // 既存の通知をキャンセル
    this.cancelGoalReminder();
    
    // 次回通知時刻を計算
    const now = new Date();
    const scheduledDate = new Date();
    scheduledDate.setHours(hour, minute, 0, 0);
    
    // 今日の時刻を過ぎていたら明日に設定
    if (scheduledDate <= now) {
      scheduledDate.setDate(scheduledDate.getDate() + 1);
    }
    
    // iOS/Android共通の通知設定
    const notificationConfig = {
      id: 'daily-goal-reminder',
      title: '目標達成確認',
      message: '今日の目標達成状況を確認しましょう',
      
      // 繰り返し設定
      repeatType: 'day' as any,  // 毎日繰り返し
      repeatTime: 1,  // 1日ごと
      
      // スケジュール時刻
      date: scheduledDate,
      
      // その他の設定
      allowWhileIdle: true,  // 省電力モード時も通知
      importance: 'high',
      priority: 'high',
      
      // カスタムデータ
      userInfo: {
        type: 'goal_reminder',
        scheduled_hour: hour,
        scheduled_minute: minute,
      },
      
      // サウンドとバイブレーション
      playSound: true,
      soundName: 'default',
      vibrate: true,
      vibration: 300,
    };
    
    // Android固有の設定
    if (Platform.OS === 'android') {
      Object.assign(notificationConfig, {
        channelId: 'goal-reminder-channel',
        smallIcon: 'ic_notification',
        largeIcon: 'ic_launcher',
        color: '#4CAF50',
        
        // Android 12以降の正確なアラーム
        exact: true,
        allowedInForeground: true,
      });
    }
    
    // iOS固有の設定
    if (Platform.OS === 'ios') {
      Object.assign(notificationConfig, {
        alertAction: '表示',
        category: 'GOAL_REMINDER',
      });
    }
    
    // 通知をスケジュール
    PushNotification.localNotificationSchedule(notificationConfig);
    
    // 設定を保存
    await this.saveReminderSettings(hour, minute);
    
    console.log(`毎日${hour}:${minute}に通知をスケジュールしました`);
  }
  
  /**
   * 目標達成状況をチェックして通知
   * （バックグラウンドタスクから呼び出す場合）
   */
  async checkAndNotifyGoalStatus(): Promise<void> {
    try {
      // 目標達成状況をチェック
      const isAchieved = await this.checkGoalAchievement();
      
      if (!isAchieved) {
        // 即座に通知
        PushNotification.localNotification({
          channelId: 'goal-reminder-channel',
          title: '目標未達成',
          message: '本日の目標がまだ達成されていません',
          bigText: '目標達成まであと少し！アプリを開いて確認しましょう。',
          color: '#FF5722',
          userInfo: { type: 'goal_not_achieved' },
        });
      }
    } catch (error) {
      console.error('Goal check failed:', error);
    }
  }
  
  /**
   * 通知のキャンセル
   */
  cancelGoalReminder(): void {
    // IDで特定の通知をキャンセル
    PushNotification.cancelLocalNotification('daily-goal-reminder');
  }
  
  /**
   * 全ての通知をキャンセル
   */
  cancelAllNotifications(): void {
    PushNotification.cancelAllLocalNotifications();
  }
  
  /**
   * 通知権限のチェック
   */
  async checkPermissions(): Promise<boolean> {
    return new Promise((resolve) => {
      PushNotification.checkPermissions((permissions) => {
        resolve(permissions.alert || permissions.badge || permissions.sound);
      });
    });
  }
  
  /**
   * 通知権限のリクエスト
   */
  async requestPermissions(): Promise<boolean> {
    return new Promise((resolve) => {
      PushNotification.requestPermissions().then((permissions) => {
        resolve(permissions.alert || permissions.badge || permissions.sound);
      });
    });
  }
  
  // ヘルパーメソッド
  private async saveReminderSettings(hour: number, minute: number): Promise<void> {
    await AsyncStorage.setItem('goal_reminder_settings', JSON.stringify({
      enabled: true,
      hour,
      minute,
      lastScheduled: new Date().toISOString(),
    }));
  }
  
  private async checkGoalAchievement(): Promise<boolean> {
    // 実際の目標達成チェックロジック
    // VitalDataServiceなどと連携
    return false; // 仮実装
  }
}

export default EnhancedNotificationService;
```

### 3.4 使用方法

#### アプリ起動時（App.tsx）
```typescript
import EnhancedNotificationService from './services/EnhancedNotificationService';

const App = () => {
  useEffect(() => {
    // 通知サービスの初期化
    const notificationService = EnhancedNotificationService.getInstance();
    
    // 権限チェックと通知スケジュール
    const setupNotifications = async () => {
      const hasPermission = await notificationService.checkPermissions();
      
      if (!hasPermission) {
        const granted = await notificationService.requestPermissions();
        if (!granted) {
          console.log('通知権限が拒否されました');
          return;
        }
      }
      
      // 毎日21時に通知をスケジュール
      await notificationService.scheduleUnlimitedDailyGoalReminder(21, 0);
    };
    
    setupNotifications();
  }, []);
  
  return <AppNavigator />;
};
```

#### 設定画面での変更
```typescript
const NotificationSettingsScreen = () => {
  const [reminderTime, setReminderTime] = useState({ hour: 21, minute: 0 });
  
  const updateReminderTime = async (hour: number, minute: number) => {
    const notificationService = EnhancedNotificationService.getInstance();
    await notificationService.scheduleUnlimitedDailyGoalReminder(hour, minute);
    setReminderTime({ hour, minute });
  };
  
  const disableReminder = () => {
    const notificationService = EnhancedNotificationService.getInstance();
    notificationService.cancelGoalReminder();
  };
  
  return (
    <View>
      <TimePicker
        value={reminderTime}
        onChange={updateReminderTime}
      />
      <Button title="通知を無効化" onPress={disableReminder} />
    </View>
  );
};
```

## 4. バックグラウンド動作の詳細

### 4.1 通知の永続性

| 状態 | 通知の動作 |
|------|----------|
| アプリ起動中 | ✅ 正常動作 |
| アプリバックグラウンド | ✅ 正常動作 |
| アプリ終了（スワイプ） | ✅ 正常動作 |
| 端末再起動 | ✅ 正常動作（Android要設定） |
| 省電力モード | ✅ 正常動作（allowWhileIdle設定） |

### 4.2 バッテリー影響
- **影響**: 最小限
- **理由**: OSのスケジューラーが効率的に管理
- **消費電力**: 通知表示時のみ（1日1回）

## 5. 注意点と制限事項

### 5.1 Android固有の制限
1. **Android 12以降**
   - SCHEDULE_EXACT_ALARM権限が必要
   - ユーザーの明示的な許可が必要

2. **メーカー固有の省電力機能**
   - Xiaomi, Huawei等は追加設定が必要な場合あり
   - アプリ設定で「自動起動」を許可

### 5.2 iOS固有の制限
1. **通知数の上限**
   - 最大64個のローカル通知
   - 古い通知は自動削除

2. **通知の更新**
   - 同じIDで上書き可能

### 5.3 共通の制限
1. **通知の保証**
   - 100%の配信保証はない
   - ユーザーが通知を無効化可能

2. **カスタマイズの制限**
   - 動的な内容変更は不可
   - 事前に設定した内容のみ

## 6. 代替案の検討

### 6.1 WorkManager + ローカル通知（Android）
```kotlin
class DailyGoalCheckWorker : Worker() {
    override fun doWork(): Result {
        // 目標達成チェック
        if (!checkGoalAchievement()) {
            showNotification()
        }
        return Result.success()
    }
}
```

### 6.2 BGTaskScheduler + ローカル通知（iOS）
```swift
BGTaskScheduler.shared.register(
    forTaskWithIdentifier: "com.app.goalcheck",
    using: nil
) { task in
    // 目標達成チェック
    if !checkGoalAchievement() {
        showNotification()
    }
    task.setTaskCompleted(success: true)
}
```

## 7. 実装推奨事項

### 7.1 段階的実装
1. **Phase 1**: 基本的なローカル通知（固定メッセージ）
2. **Phase 2**: 時刻設定機能
3. **Phase 3**: 条件付き通知（目標未達成時のみ）

### 7.2 テスト方法
```typescript
// デバッグ用：即座に通知を表示
const testNotification = () => {
  PushNotification.localNotification({
    title: "テスト通知",
    message: "通知機能が正常に動作しています",
  });
};

// デバッグ用：5秒後に通知
const testScheduledNotification = () => {
  PushNotification.localNotificationSchedule({
    title: "スケジュールテスト",
    message: "5秒後の通知です",
    date: new Date(Date.now() + 5000),
  });
};
```

## 8. まとめ

### 実現可能性: ✅ 可能

**理由**:
1. OSレベルの通知スケジューラーを利用
2. アプリ常駐不要
3. 無期限の繰り返し設定が可能
4. バックグラウンドでも動作継続

**推奨実装**:
- react-native-push-notificationライブラリ
- repeatType: 'day'で毎日繰り返し
- アプリ起動時に一度設定すれば永続的に動作

**注意点**:
- プラットフォーム別の設定が必要
- ユーザーの通知許可が前提
- 省電力モード対応の考慮