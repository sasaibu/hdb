# PUSH通知機能仕様

## メモ

- 設定時刻はあくまでこの時間にこれをやろうという目標設定であって、期限じゃない
- キャンセルについては、一度達成したがその達成をキャンセルにしてもう一度目標達成を目指すことを指す
- 




## 概要
HDBアプリにおけるPUSH通知の機能仕様を定義します。
本仕様では、通知配信方式として、目標設定通知はアプリ（ローカル通知）から、その他の通知はFCM（Firebase Cloud Messaging）から送信します。

## 通知機能一覧

| 通知種別 | 通知概要 | 配信方式 | 配信タイミング | 優先度 |
|---------|----------|----------|---------------|--------|
| 新規お知らせ | HDBシステムからの重要なお知らせや更新情報 | FCM | HDBシステム管理者が配信設定 | 中 |
| 未閲覧の健診 | 健康診断の予約締切や受診日のリマインダー | FCM | 締切7日前〜受診前日 | 高 |
| パルスサーベイ | パルスサーベイ回答依頼通知 | FCM | 回答期間開始時・リマインダー | 中 |
| ストレスチェック | ストレスチェック回答依頼通知 | FCM | 実施期間開始時・リマインダー | 中 |
| 目標設定 | 目標達成・促進・期限超過通知 | アプリ（ローカル通知） | 目標達成時・期限前・期限超過時 | 中 |

## 1. 新規お知らせ通知（FCM配信）

### 機能概要
HDBシステムからの重要なお知らせや更新情報を配信する通知

### 通知カテゴリと内容

| カテゴリ | タイトル例 | 本文例 | 優先度 |
|---------|-----------|--------|--------|
| システムメンテナンス | 「システムメンテナンスのお知らせ」 | 「○月○日○時〜○時までメンテナンスを実施します」 | 高 |
| 新機能 | 「新機能が追加されました」 | 「血圧グラフ表示機能が利用可能になりました」 | 中 |
| 健康情報 | 「健康情報のお知らせ」 | 「インフルエンザ予防接種のご案内」 | 低 |
| イベント・キャンペーン | 「ウォーキングイベント開催」 | 「春のウォーキングチャレンジが始まります」 | 低 |

### 配信制御
- HDBシステム管理者が配信対象と内容を設定
- 対象者をセグメント化して配信可能（全員/特定グループ）
- 配信予約機能

### 通知後の動作
- 通知タップ時：お知らせ詳細画面またはWebViewへ遷移
- 未読/既読管理
- お知らせ一覧での履歴確認が可能

## 2. 未閲覧の健診通知（FCM配信）

### 機能概要
健康診断の予約締切や受診日が近づいた際に送信されるリマインダー通知

### 通知内容とタイミング

| タイミング | タイトル | 本文 | 配信時刻 |
|-----------|---------|------|----------|
| 締切7日前 | 「健診予約のお知らせ」 | 「健診予約の締切まであと7日です」 | 9:00 |
| 締切3日前 | 「健診予約締切が近づいています」 | 「健診予約の締切まであと3日です」 | 9:00 |
| 締切前日 | 「【重要】健診予約締切は明日です」 | 「明日が健診予約の締切日です。お早めにご予約ください」 | 9:00 |
| 受診前日 | 「明日は健診受診日です」 | 「明日の健診受診をお忘れなく」 | 9:00 |

### 通知設定
- ユーザーは通知設定画面でリマインダーのON/OFFが可能
- 通知時刻の設定が可能（デフォルト：9:00）

### 通知後の動作
- 通知タップ時：WebView経由で健診予約画面へ遷移
- 既読フラグを立てて重複通知を防止

## 3. パルスサーベイ通知（FCM配信）

### 機能概要
パルスサーベイの回答依頼・リマインダー通知

### 通知内容とタイミング

| タイミング | タイトル | 本文 | 配信時刻 |
|-----------|---------|------|----------|
| 回答期間開始 | 「パルスサーベイのお知らせ」 | 「新しいパルスサーベイの回答期間が始まりました」 | 9:00 |
| 回答期限3日前 | 「パルスサーベイ回答期限が近づいています」 | 「パルスサーベイの回答期限まであと3日です」 | 9:00 |
| 回答期限前日 | 「【重要】パルスサーベイ回答期限は明日です」 | 「明日がパルスサーベイの回答期限です。お早めにご回答ください」 | 9:00 |

### 通知設定
- ユーザーは通知設定画面でON/OFFが可能
- 通知時刻の設定が可能（デフォルト：9:00）

### 通知後の動作
- 通知タップ時：WebView経由でパルスサーベイ画面へ遷移
- 回答済みフラグ管理

## 4. ストレスチェック通知（FCM配信）

### 機能概要
ストレスチェックの実施依頼・リマインダー通知

### 通知内容とタイミング

| タイミング | タイトル | 本文 | 配信時刻 |
|-----------|---------|------|----------|
| 実施期間開始 | 「ストレスチェックのお知らせ」 | 「ストレスチェックの実施期間が始まりました」 | 9:00 |
| 実施期限1週間前 | 「ストレスチェック実施期限が近づいています」 | 「ストレスチェックの実施期限まであと1週間です」 | 9:00 |
| 実施期限3日前 | 「ストレスチェック実施期限が近づいています」 | 「ストレスチェックの実施期限まであと3日です」 | 9:00 |
| 実施期限前日 | 「【重要】ストレスチェック実施期限は明日です」 | 「明日がストレスチェックの実施期限です。お早めに実施してください」 | 9:00 |

### 通知設定
- ユーザーは通知設定画面でON/OFFが可能
- 通知時刻の設定が可能（デフォルト：9:00）

### 通知後の動作
- 通知タップ時：WebView経由でストレスチェック画面へ遷移
- 実施済みフラグ管理

## 5. 目標設定通知（アプリ配信）

### 機能概要
ユーザーが設定したバイタルデータの目標に関する通知（アプリ内ローカル通知）

### 通知種別と内容

#### 5.1 目標達成通知

| 項目 | 内容 |
|------|------|
| 配信タイミング | バイタルデータがアプリ内DBに保存され、目標値に到達した時点 |
| 配信制限 | 1日1回まで（同じ種類の目標達成通知は重複送信しない） |
| タイトル | 「目標達成おめでとうございます！」 |
| 本文例 | 「今日の歩数目標を達成しました」「目標体重に到達しました」 |

#### 5.2 目標達成促進通知（リマインダー）

| バイタル種別 | タイトル | 本文例 | 通知タイミング |
|------------|---------|--------|---------------|
| 歩数 | 「目標達成まであと少し！」 | 「現在7,500歩。目標の10,000歩まであと2,500歩です」 | 12:00、18:00、20:00 |
| 体重 | 「体重を記録しましょう」 | 「本日の体重目標の記録期限が近づいています」 | 期限2時間前 |
| 血圧 | 「血圧を測定しましょう」 | 「血圧測定の目標時刻が近づいています」 | 期限2時間前 |
| 体温 | 「体温を記録しましょう」 | 「体温測定の目標時刻が近づいています」 | 期限2時間前 |
| 心拍数 | 「心拍数を記録しましょう」 | 「心拍数測定の目標時刻が近づいています」 | 期限2時間前 |

#### 5.3 目標期限超過通知

| 項目 | 内容 |
|------|------|
| 配信タイミング | 目標期限の翌日9:00、週次目標の場合は週明け月曜日の9:00 |
| タイトル | 「昨日の目標について」 |
| 本文例 | 「昨日の歩数は8,000歩でした。今日は目標達成を目指しましょう！」 |

### 目標設定通知の時間制御

| 目標期限時刻 | リマインド通知時刻 | 理由 |
|-------------|------------------|------|
| 0:00〜9:00 | 前日の20:00 | 深夜・早朝の目標は前日夜に通知 |
| 9:00〜12:00 | 当日の期限2時間前 | 通常ルール適用 |
| 12:00〜20:00 | 当日の期限2時間前 | 通常ルール適用 |
| 20:00〜22:00 | 当日の18:00 | 2時間前だと夜遅くなるため早めに |
| 22:00〜24:00 | 当日の20:00 | 夜間制限を考慮 |

### 通知設定
- ユーザーごとに促進通知のON/OFF設定可能
- 通知回数の設定（1日1回/複数回）
- カスタム通知時刻の設定も可能

### 通知後の動作
- 通知タップ時：該当するバイタルデータ画面へ遷移
- 目標設定画面へのショートカットボタンを表示
- 達成状況をグラフで視覚的に表示

## 6. 通知配信方式の詳細

### FCM（Firebase Cloud Messaging）配信
- **対象通知**：新規お知らせ、未閲覧の健診、パルスサーベイ、ストレスチェック
- **配信元**：HDBサーバー
- **特徴**：リモートからの一括配信、配信状況の管理が可能

### アプリ配信（ローカル通知）
- **対象通知**：目標設定関連通知
- **配信元**：HDBアプリ
- **特徴**：オフライン状態でも配信可能、端末内で完結

## 7. 通知の共通仕様

### 通知の優先度設定

| 通知種別 | 優先度 | 理由 |
|---------|--------|------|
| 未閲覧の健診（前日） | 高 | 期限が迫っているため |
| 新規お知らせ（メンテナンス） | 高 | サービス利用に影響 |
| 目標達成 | 中 | ポジティブフィードバック |
| パルスサーベイ | 中 | 回答期限あり |
| ストレスチェック | 中 | 実施期限あり |
| 新規お知らせ（一般） | 低 | 情報提供のみ |

### 通知の配信時間制御
- 夜間配信制限：22:00〜7:00は配信しない（緊急通知を除く）
- ユーザー設定による配信時間帯の指定可能

### 通知設定画面
- 通知種別ごとにON/OFF設定可能
- 配信時刻の個別設定可能
- 通知音・バイブレーションの設定可能

### 通知履歴管理
- 全ての通知をローカルDBに保存
- 通知履歴画面で過去30日分を確認可能
- 通知ごとの開封率をトラッキング

### エラーハンドリング
- 通知送信失敗時は3回までリトライ
- FCMトークン無効時は次回アプリ起動時に再取得
- ネットワークエラー時はキューに保存して後で再送信