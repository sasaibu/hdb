# PUSH通知機能仕様

## 概要
HDBアプリにおけるPUSH通知の機能仕様を定義します。

## 通知機能一覧

## 1. 目標関連通知

### 1.1 目標達成通知

#### 機能概要
ユーザーが設定したバイタルデータの目標を達成した際に送信される通知

#### 対象バイタルデータ
- 歩数
- 体重
- 血圧（収縮期/拡張期）
- 体温
- 心拍数

#### 通知タイミング
- バイタルデータがアプリ内DBに保存され、目標値に到達した時点
- 1日1回まで（同じ種類の目標達成通知は重複送信しない）

#### 通知内容

| 項目 | 内容例 |
|------|--------|
| タイトル | 「目標達成おめでとうございます！」 |
| 本文 | 「今日の歩数目標を達成しました」<br/>「目標体重に到達しました」 |
| アイコン | 達成バッジアイコン |
| サウンド | achievement.mp3（カスタムサウンド） |

### 1.2 目標達成促進通知（リマインダー）

#### 機能概要
目標期限が近づいているが未達成の場合に、目標達成を促す通知

#### 通知タイミングの仕様

##### 基本ルール
1. **目標期限の2時間前**を基本のリマインド時刻とする
2. **夜間制限**：22:00〜7:00の間は通知しない
3. **最適化ルール**を適用して効果的な時刻に調整

##### 最適化ルール

| 目標期限時刻 | リマインド通知時刻 | 理由 |
|-------------|------------------|------|
| 0:00〜9:00 | 前日の20:00 | 深夜・早朝の目標は前日夜に通知 |
| 9:00〜12:00 | 当日の期限2時間前 | 通常ルール適用 |
| 12:00〜20:00 | 当日の期限2時間前 | 通常ルール適用 |
| 20:00〜22:00 | 当日の18:00 | 2時間前だと夜遅くなるため早めに |
| 22:00〜24:00 | 当日の20:00 | 夜間制限を考慮 |

##### 特殊ケース

###### 歩数目標の場合
- 目標期限に関わらず、以下の3回通知
  - 12:00（昼休み）：「現在○歩です。目標まであと○歩！」
  - 18:00（退勤時）：「現在○歩です。帰り道で目標達成しましょう」
  - 20:00（最終）：「本日の目標まであと○歩です」

###### 体重・血圧等の測定系目標
- 目標期限の2時間前に1回のみ通知
- 「体重を測定して記録しましょう」

#### 通知内容

| バイタル種別 | タイトル | 本文例 |
|------------|---------|--------|
| 歩数 | 「目標達成まであと少し！」 | 「現在7,500歩。目標の10,000歩まであと2,500歩です」 |
| 体重 | 「体重を記録しましょう」 | 「本日の体重目標の記録期限が近づいています」 |
| 血圧 | 「血圧を測定しましょう」 | 「血圧測定の目標時刻が近づいています」 |

#### 通知設定
- ユーザーごとに促進通知のON/OFF設定可能
- 通知回数の設定（1日1回/複数回）
- カスタム通知時刻の設定も可能

#### 通知の抑制条件
- すでに目標を達成している場合は通知しない
- 目標期限を過ぎている場合は通知しない
- 同日に同じ種類の促進通知を送信済みの場合は追加送信しない（歩数を除く）

### 1.3 目標期限超過通知

#### 機能概要
目標期限を過ぎても未達成の場合の通知（オプション機能）

#### 通知タイミング
- 目標期限の翌日9:00
- 週次目標の場合は週明け月曜日の9:00

#### 通知内容
| 項目 | 内容例 |
|------|--------|
| タイトル | 「昨日の目標について」 |
| 本文 | 「昨日の歩数は8,000歩でした。今日は目標達成を目指しましょう！」 |

### 通知後の動作（共通）
- 通知タップ時：該当するバイタルデータ画面へ遷移
- 目標設定画面へのショートカットボタンを表示
- 達成状況をグラフで視覚的に表示

## 2. 健診リマインダー通知

### 機能概要
健康診断の予約締切や受診日が近づいた際に送信されるリマインダー通知

### 通知タイミング
- 予約締切の7日前
- 予約締切の3日前
- 予約締切の前日
- 受診日の前日

### 通知内容

| タイミング | タイトル | 本文 |
|-----------|---------|------|
| 締切7日前 | 「健診予約のお知らせ」 | 「健診予約の締切まであと7日です」 |
| 締切3日前 | 「健診予約締切が近づいています」 | 「健診予約の締切まであと3日です」 |
| 締切前日 | 「【重要】健診予約締切は明日です」 | 「明日が健診予約の締切日です。お早めにご予約ください」 |
| 受診前日 | 「明日は健診受診日です」 | 「明日の健診受診をお忘れなく」 |

### 通知設定
- ユーザーは通知設定画面でリマインダーのON/OFFが可能
- 通知時刻の設定が可能（デフォルト：9:00）

### 通知後の動作
- 通知タップ時：WebView経由で健診予約画面へ遷移
- 既読フラグを立てて重複通知を防止

## 3. お知らせ通知

### 機能概要
HDBシステムからの重要なお知らせや更新情報を配信する通知

### 通知カテゴリ
- システムメンテナンス情報
- 新機能のお知らせ
- 健康関連の情報提供
- イベント・キャンペーン情報

### 通知内容

| カテゴリ | タイトル例 | 本文例 |
|---------|-----------|--------|
| メンテナンス | 「システムメンテナンスのお知らせ」 | 「○月○日○時〜○時までメンテナンスを実施します」 |
| 新機能 | 「新機能が追加されました」 | 「血圧グラフ表示機能が利用可能になりました」 |
| 健康情報 | 「健康情報」 | 「インフルエンザ予防接種のご案内」 |
| イベント | 「ウォーキングイベント開催」 | 「春のウォーキングチャレンジが始まります」 |

### 配信制御
- HDBシステム管理者が配信対象と内容を設定
- 対象者をセグメント化して配信可能（全員/特定グループ）
- 配信予約機能

### 通知後の動作
- 通知タップ時：お知らせ詳細画面またはWebViewへ遷移
- 未読/既読管理
- お知らせ一覧での履歴確認が可能

## 4. バイタルデータ入力促進通知

### 機能概要
一定期間バイタルデータの入力がない場合に送信される促進通知

### 通知条件
- 歩数：3日間データなし
- 体重：7日間データなし
- 血圧：14日間データなし
- その他：設定された期間データなし

### 通知内容

| データ種別 | タイトル | 本文 |
|-----------|---------|------|
| 歩数 | 「歩数を記録しましょう」 | 「最後の歩数記録から3日経過しています」 |
| 体重 | 「体重を記録しましょう」 | 「定期的な体重記録で健康管理を」 |
| 血圧 | 「血圧測定のお知らせ」 | 「血圧を測定して記録しましょう」 |

### 通知設定
- ユーザーごとに促進通知のON/OFF設定可能
- データ種別ごとに個別設定可能
- 通知頻度の調整（1日1回まで）

### 通知後の動作
- 通知タップ時：該当するバイタル入力画面へ直接遷移
- スヌーズ機能（「後で通知」オプション）

## 5. 通知の共通仕様

### 通知の優先度設定

| 通知種別 | 優先度 | 理由 |
|---------|--------|------|
| 健診リマインダー（前日） | 高 | 期限が迫っているため |
| 目標達成 | 中 | ポジティブフィードバック |
| お知らせ（メンテナンス） | 高 | サービス利用に影響 |
| お知らせ（一般） | 低 | 情報提供のみ |
| 入力促進 | 低 | リマインダー |

### 通知の配信時間制御
- 夜間配信制限：22:00〜7:00は配信しない（緊急通知を除く）
- ユーザー設定による配信時間帯の指定可能

### 通知履歴管理
- 全ての通知をローカルDBに保存
- 通知履歴画面で過去30日分を確認可能
- 通知ごとの開封率をトラッキング

### エラーハンドリング
- 通知送信失敗時は3回までリトライ
- FCMトークン無効時は次回アプリ起動時に再取得
- ネットワークエラー時はキューに保存して後で再送信