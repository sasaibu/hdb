# 新ER図 テーブル定義

## 概要
新アプリのER図設計（サーバー側設計をベースとしているため、アプリ実装時は調整が必要）

## エンティティ構造

### ユーザー情報
| フィールド名 | 型 | 備考 |
|-------------|----|----- |
| ユーザーNO | - | 主キー |
| ユーザーID | - | - |

### データソース情報
| フィールド名 | 型 | 備考 |
|-------------|----|----- |
| データソースNO | - | 主キー |
| ソース名 | - | - |
| デバイス名 | - | - |

### バイタルデータ
| フィールド名 | 型 | 備考 |
|-------------|----|----- |
| バイタルID | - | 主キー |
| 測定項目コード | - | - |
| ユーザーNO | - | 外部キー |
| データソースNO | - | 外部キー |
| 測定開始日時 | - | - |
| 測定終了日時 | - | - |
| 測定値1 | - | - |
| 測定値2 | - | - |
| 測定値3 | - | - |
| 手入力フラグ | - | - |
| 送信済フラグ | - | - |

### 1日の歩数データ
| フィールド名 | 型 | 備考 |
|-------------|----|----- |
| 日付 | - | 主キー |
| ユーザーNO | - | 外部キー |
| データソースNO | - | 外部キー |
| 歩数（概算） | - | - |
| 歩数（手入力） | - | - |
| 送信済フラグ | - | - |

### 1日の心拍データ
| フィールド名 | 型 | 備考 |
|-------------|----|----- |
| 日付 | - | 主キー |
| ユーザーNO | - | 外部キー |
| データソースNO | - | 外部キー |
| 最小値 | - | - |
| 最大値 | - | - |
| 送信済フラグ | - | - |

## 測定項目コード
| コード | 項目名 |
|--------|--------|
| 1000 | 歩数（概算） |
| 1001 | 歩数（手入力） |
| 1100 | 体重 |
| 1101 | 体脂肪率 |
| 1200 | 血圧 |
| 1210 | 心拍数 |
| 1400 | 体温 |

## アプリ固有テーブル

### セッション情報（session_info）
| カラム名 | 説明 |
|---------|------|
| ユーザーID | トークン取得APIで取得 |
| ログイン状態 | デバイス情報登録・更新APIで取得 |
| 利用権限配列 | デバイス情報登録・更新API、トークン取得APIで取得 |
| 移行データ情報 | デバイス情報登録・更新API、トークン取得APIで取得 |
| ステート | ログインAPIで取得（Webで使用する値のためアプリ側は不要） |
| デバイス情報登録・更新API最終実行日時 | 1日1回実行制御用 |

### デバイス情報（device_info）
| カラム名 | 説明 |
|---------|------|
| デバイスID | デバイス情報登録・更新APIで取得 |
| OS | Firebaseから都度取得 |
| バージョン | Firebaseから都度取得 |
| デバイストークン最終使用日時 | 270日無使用で期限切れとなるため |

### マイデータ（my_data）
| カラム名 | 説明 |
|---------|------|
| ニックネーム | - |
| アイコン画像パス | S3キー |
| アイコン画像パス（ローカル） | オフライン用、自身の画像のみ保持 |

### 目標
| カラム名 | 説明 |
|---------|------|
| 目標情報 | デバイス情報登録・更新API、トークン取得APIで取得 |
| 目標達成状況 | - |

### バイタルデータ（種別ごと）

#### 歩数
| カラム名 | 説明 |
|---------|------|
| 日付 | - |
| 時間 | TOの値 |
| 歩数 | - |
| 手入力フラグ | 手入力判定で使用 |

#### 体重
| カラム名 | 説明 |
|---------|------|
| 日付 | - |
| 時間 | - |
| 体重 | - |
| 体脂肪率 | - |

#### 血圧
| カラム名 | 説明 |
|---------|------|
| 日付 | - |
| 時間 | - |
| 最高 | - |
| 最低 | - |
| 心拍数 | - |
| 脈拍 | 心拍数と別で表示させる仕様のため追加 |

#### 体温
| カラム名 | 説明 |
|---------|------|
| 日付 | - |
| 時間 | - |
| 体温 | - |

## ストレージ設計

### AsyncStorage
| キー | 説明 |
|------|------|
| 新アプリ連携フラグ | 連携サービス設定（Android用） |
| ヘルスコネクト連携フラグ | 連携サービス設定（Android用） |
| ヘルスケア連携フラグ | 連携サービス設定（iOS用） |
| 新規お知らせ通知可否 | 通知設定 |
| 未閲覧の検診通知可否 | 通知設定 |
| パルスサーベイ通知可否 | 通知設定 |
| ストレスチェック通知可否 | 通知設定 |

### Keychain/Keystore
| キー | 説明 |
|------|------|
| 認可コード | ログインAPIで取得 |
| アクセストークン | トークン取得APIで取得 |
| アクセストークンの有効期限 | トークン取得APIで取得 |
| リフレッシュトークン | トークン取得APIで取得 |
| デバイストークン | Firebaseから取得 |

## 設計上の考慮事項

### バイタルID
Health ConnectやHealthKitからの判別で使用する

### ユーザーNO
- ログイン・ログアウト・別ユーザーでログイン実装時の制御
- バイタルデータテーブルサイズ削減
- 転職時のデータ付け替え対応

### データソースNO
- バイタルデータテーブルサイズ削減
- 複数デバイス（スマホ・Apple Watch等）のデータ混在対応

### 測定値1、測定値2、測定値3
- Health Connect/HealthKitの複数値対応（収縮期・拡張期血圧等）
- 将来拡張用（測定値3）

### 1日の歩数データテーブル
- バイタルデータテーブルからの集計処理負荷軽減
- 複数デバイス歩数の最大値送信対応

### 1日の心拍データテーブル
- 歩数データと同様の考慮事項
